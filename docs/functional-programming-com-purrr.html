<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Capítulo 16 Functional programming com purrr | Introdução à Linguagem R: seus fundamentos e sua prática</title>
<meta name="author" content="Pedro Faria">
<meta name="description" content="16.1 Introdução Neste capítulo, vamos introduzir um outro pacote do tidyverse, chamado de purrr. Esse pacote provê um conjunto de ferramentas que ampliam as funcionalidades de functional...">
<meta name="generator" content="bookdown 0.30 with bs4_book()">
<meta property="og:title" content="Capítulo 16 Functional programming com purrr | Introdução à Linguagem R: seus fundamentos e sua prática">
<meta property="og:type" content="book">
<meta property="og:url" content="bem-vindo.html/functional-programming-com-purrr.html">
<meta property="og:image" content="bem-vindo.html/capa.png">
<meta property="og:description" content="16.1 Introdução Neste capítulo, vamos introduzir um outro pacote do tidyverse, chamado de purrr. Esse pacote provê um conjunto de ferramentas que ampliam as funcionalidades de functional...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Capítulo 16 Functional programming com purrr | Introdução à Linguagem R: seus fundamentos e sua prática">
<meta name="twitter:description" content="16.1 Introdução Neste capítulo, vamos introduzir um outro pacote do tidyverse, chamado de purrr. Esse pacote provê um conjunto de ferramentas que ampliam as funcionalidades de functional...">
<meta name="twitter:image" content="bem-vindo.html/capa.png">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.4.0/transition.js"></script><script src="libs/bs3compat-0.4.0/tabs.js"></script><script src="libs/bs3compat-0.4.0/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<style type="text/css">
    /* Used with Pandoc 2.11+ new --citeproc when CSL is used */
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
          margin-bottom: 1em;
        }
    .hanging div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }
  </style>
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Introdução à Linguagem R: seus fundamentos e sua prática</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Bem vindo!</a></li>
<li><a class="" href="como-citar-a-obra.html">Como citar a obra:</a></li>
<li><a class="" href="sobre-o-autor.html">Sobre o autor</a></li>
<li><a class="" href="pref%C3%A1cio.html">Prefácio</a></li>
<li class="book-part">Introduzindo a Linguagem R</li>
<li><a class="" href="no%C3%A7%C3%B5es-b%C3%A1sicas-do-r.html"><span class="header-section-number">1</span> Noções Básicas do R</a></li>
<li><a class="" href="fundamentos-da-linguagem-r.html"><span class="header-section-number">2</span> Fundamentos da Linguagem R</a></li>
<li class="book-part">Importando, organizando e transformando dados</li>
<li><a class="" href="introduzindo-o-universo-do-tidyverse.html"><span class="header-section-number">3</span> Introduzindo o universo do tidyverse</a></li>
<li><a class="" href="importando-e-exportando-dados-com-readr-readxl-e-haven.html"><span class="header-section-number">4</span> Importando e exportando dados com readr, readxl e haven</a></li>
<li><a class="" href="transformando-dados-com-dplyr.html"><span class="header-section-number">5</span> Transformando dados com dplyr</a></li>
<li><a class="" href="introdu%C3%A7%C3%A3o-a-base-de-dados-relacionais-com-dplyr.html"><span class="header-section-number">6</span> Introdução a base de dados relacionais com dplyr</a></li>
<li><a class="" href="tidy-data-uma-abordagem-para-organizar-os-seus-dados-com-tidyr.html"><span class="header-section-number">7</span> Tidy Data: uma abordagem para organizar os seus dados com tidyr</a></li>
<li class="book-part">Visualizando seus dados</li>
<li><a class="" href="visualiza%C3%A7%C3%A3o-de-dados-com-ggplot2.html"><span class="header-section-number">8</span> Visualização de dados com ggplot2</a></li>
<li><a class="" href="configurando-componentes-est%C3%A9ticos-do-gr%C3%A1fico-no-ggplot2.html"><span class="header-section-number">9</span> Configurando componentes estéticos do gráfico no ggplot2</a></li>
<li class="book-part">Ferramentas para tipos específicos de dados</li>
<li><a class="" href="manipula%C3%A7%C3%A3o-e-transforma%C3%A7%C3%A3o-de-strings-com-stringr.html"><span class="header-section-number">10</span> Manipulação e transformação de strings com stringr</a></li>
<li><a class="" href="introduzindo-fatores-factors-com-forcats.html"><span class="header-section-number">11</span> Introduzindo fatores (factor’s) com forcats</a></li>
<li><a class="" href="introdu%C3%A7%C3%A3o-%C3%A0-vari%C3%A1veis-de-tempo-com-lubridate.html"><span class="header-section-number">12</span> Introdução à variáveis de tempo com lubridate</a></li>
<li class="book-part">Funções e Loops: construindo os seus próprios programas e automatizando tarefas</li>
<li><a class="" href="controle-condicional-de-fluxo.html"><span class="header-section-number">13</span> Controle condicional de fluxo</a></li>
<li><a class="" href="fun%C3%A7%C3%B5es.html"><span class="header-section-number">14</span> Funções</a></li>
<li><a class="" href="loops.html"><span class="header-section-number">15</span> Loops</a></li>
<li><a class="active" href="functional-programming-com-purrr.html"><span class="header-section-number">16</span> Functional programming com purrr</a></li>
<li><a class="" href="debugging---resolvendo-bugs-em-suas-fun%C3%A7%C3%B5es.html"><span class="header-section-number">17</span> Debugging - Resolvendo bugs em suas funções</a></li>
<li><a class="" href="environments-ou-ambientes-no-r.html"><span class="header-section-number">18</span> Environments ou ambientes no R</a></li>
<li class="book-part">Respostas dos exercícios de cada capítulo</li>
<li><a class="" href="respostas.html">Respostas</a></li>
<li class="book-part">Apêndices</li>
<li><a class="" href="pnad-cont%C3%ADnua-arquivo-csv-para-input.html"><span class="header-section-number">A</span> PNAD Contínua: arquivo CSV para input</a></li>
<li><a class="" href="refer%C3%AAncias.html">Referências</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/pedropark99/Introducao_R/">View book source <i class="fas fa-book-open"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="functional-programming-com-purrr" class="section level1" number="16">
<h1>
<span class="header-section-number">Capítulo 16</span> <em>Functional programming</em> com <code>purrr</code><a class="anchor" aria-label="anchor" href="#functional-programming-com-purrr"><i class="fas fa-link"></i></a>
</h1>
<div id="introdução-2" class="section level2" number="16.1">
<h2>
<span class="header-section-number">16.1</span> Introdução<a class="anchor" aria-label="anchor" href="#introdu%C3%A7%C3%A3o-2"><i class="fas fa-link"></i></a>
</h2>
<p>Neste capítulo, vamos introduzir um outro pacote do <code>tidyverse</code>, chamado de <code>purrr</code>. Esse pacote provê um conjunto de ferramentas que ampliam as funcionalidades de <em>functional programming</em> do R. Para ter acesso às funções desse pacote, você pode chamar tanto pelo <code>tidyverse</code> quanto pelo <code>purrr</code> diretamente.</p>
<p></p>
<div class="sourceCode" id="cb1636"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://purrr.tidyverse.org/">purrr</a></span><span class="op">)</span></span></code></pre></div>
<p></p>
</div>
<div id="loops-implícitos-com-a-família-map" class="section level2" number="16.2">
<h2>
<span class="header-section-number">16.2</span> <em>Loops</em> implícitos com a família <code>map</code><a class="anchor" aria-label="anchor" href="#loops-impl%C3%ADcitos-com-a-fam%C3%ADlia-map"><i class="fas fa-link"></i></a>
</h2>
<p>A principal fraqueza de um <code>for</code> <em>loop</em> é que ele foca demasiada atenção sobre os objetos envolvidos na iteração. Isso por um lado é bom, pois você consegue identificar todas as “dependências” de um <code>for</code> <em>loop</em>, mas, por um outro lado, é ruim. Pois na maioria das vezes, é muito mais importante identificarmos a ação, a transformação ou a funcionalidade que está sendo aplicada sobre esses objetos em cada iteração.</p>
<p>Por exemplo, abaixo temos dois <code>for</code> <em>loops</em> diferentes que aplicam uma determinada operação sobre o objeto <code>tab</code>. O que cada <code>for</code> <em>loop</em> abaixo está fazendo? Qual a diferença entre eles? Após observá-los por um tempo você vai acabar percebendo que a única diferença entre esses dois <code>for</code> <em>loops</em> está na função que está sendo aplicada sobre cada coluna de <code>tab</code>.</p>
<p></p>
<div class="sourceCode" id="cb1637"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>  x1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>,</span>
<span>  x2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>,</span>
<span>  x3 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>,</span>
<span>  x4 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">vec1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span><span class="st">"double"</span>, length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">tab</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">tab</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">vec1</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">tab</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span></span>
<span><span class="va">vec2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span><span class="st">"double"</span>, length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">tab</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">tab</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">vec2</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">tab</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">vec1</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] -0.52620962  0.49760887  0.24003168 -0.02559521</code></pre>
<div class="sourceCode" id="cb1639"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">vec2</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] -0.56059544  0.32895476  0.19140022  0.08733386</code></pre>
<p></p>
<p>É esse o problema que a família de funções <code>map</code> busca solucionar, ao nos fornecer um meio de construirmos <em>loops</em> em um formato mais funcional, destacando assim, as transformações e funções que estamos aplicando em cada repetição, ao invés dos objetos envolvidos na iteração. Como exemplo, podemos replicar o mesmo exemplo de <code>for</code> <em>loops</em> acima, utilizando a família de funções <code>map</code>, da seguinte forma:</p>
<p></p>
<div class="sourceCode" id="cb1641"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://purrr.tidyverse.org/">purrr</a></span><span class="op">)</span></span>
<span><span class="va">vec1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl</a></span><span class="op">(</span><span class="va">tab</span>, <span class="va">mean</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">vec2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl</a></span><span class="op">(</span><span class="va">tab</span>, <span class="va">median</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">vec1</span><span class="op">)</span></span></code></pre></div>
<pre><code>##          x1          x2          x3          x4 
## -0.52620962  0.49760887  0.24003168 -0.02559521</code></pre>
<div class="sourceCode" id="cb1643"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">vec2</span><span class="op">)</span></span></code></pre></div>
<pre><code>##          x1          x2          x3          x4 
## -0.56059544  0.32895476  0.19140022  0.08733386</code></pre>
<p></p>
<p>Perceba acima, o quão simples e sucinto é para expressarmos uma operação com a família <code>map</code>. Vamos explicar daqui a pouco, em detalhes como essas funções funcionam. Por enquanto, quero apenas destacar que agora com a função <code><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl()</a></code>, está muito fácil de identificarmos a diferença entre os dois <em>loops</em> acima. Pois a única coisa que está de fato mudando entre uma linha e outra, é a função aplicada sobre cada coluna de <code>tab</code>, que são as funções <code><a href="https://rdrr.io/r/base/mean.html">mean()</a></code> e <code><a href="https://rdrr.io/r/stats/median.html">median()</a></code>. Dessa forma, você pode rapidamente entender que o primeiro <em>loop</em> está calculando a média de cada coluna, enquanto o segundo <em>loop</em>, está calculando a mediana.</p>
<div id="a-família-de-funções-map" class="section level3" number="16.2.1">
<h3>
<span class="header-section-number">16.2.1</span> A família de funções <code>map()</code><a class="anchor" aria-label="anchor" href="#a-fam%C3%ADlia-de-fun%C3%A7%C3%B5es-map"><i class="fas fa-link"></i></a>
</h3>
<p>Portanto, o pacote <code>purrr</code> nos oferece a família de funções <code>map</code>, a qual possui 7 membros diferentes, sendo eles:</p>
<ul>
<li>
<code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code>: retorna uma lista.</li>
<li>
<code><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl()</a></code>: retorna um vetor atômico do tipo <code>double</code>.</li>
<li>
<code><a href="https://purrr.tidyverse.org/reference/map.html">map_chr()</a></code>: retorna um vetor atômico do tipo <code>character</code>.</li>
<li>
<code><a href="https://purrr.tidyverse.org/reference/map.html">map_int()</a></code>: retorna um vetor atômico do tipo <code>integer</code>.</li>
<li>
<code><a href="https://purrr.tidyverse.org/reference/map.html">map_lgl()</a></code>: retorna um vetor atômico do tipo <code>logical</code>.</li>
<li>
<code><a href="https://purrr.tidyverse.org/reference/map.html">map_dfr()</a></code> e <code><a href="https://purrr.tidyverse.org/reference/map.html">map_dfc()</a></code>: retornam um <code>data.frame</code>.</li>
</ul>
<p>Todas essas 7 funções possuem os mesmos argumentos e realizam exatamente o mesmo trabalho. A única diferença entre elas, está na estrutura de dado em que o resultado é retornado. Tal estrutura é identificada pelo sufixo presente no nome de cada função. Portanto, todas essas funções <code>map</code> aceitam um objeto como <em>input</em>, e retornam como <em>output</em>, um novo objeto de mesmo comprimento que o objeto de <em>input</em>, e na estrutura identificada pelo sufixo no nome da função <span class="citation">(<a href="refer%C3%AAncias.html#ref-wickham2017" role="doc-biblioref">WICKHAM; GROLEMUND, 2017</a>)</span>.</p>
<p>Toda função <code>map</code> possui 3 argumentos principais, sendo eles: 1) <code>.x</code>, que é o objeto sobre o qual <code>map</code> vai iterar, ou, sobre o qual ela vai aplicar o <em>loop</em>; 2) <code>.f</code>, que é a função a ser aplicada sobre cada elemento de <code>.x</code>; e 3) <code>...</code>, que é a lista de argumentos a serem repassados para a função definida em <code>.f</code>.</p>
<p>Em resumo, todas as funções <code>map</code> buscam aplicar a função definida em <code>.f</code> sobre cada elemento do objeto <code>.x</code>. Consequentemente, o resultado de toda função <code>map</code> é um novo objeto contendo os resultados da função definida em <code>.f</code> aplicada sobre cada elemento do objeto definido em <code>.x</code>. Tal ação, está representada na figura 16.1.</p>
<p></p>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:unnamed-chunk-872"></span>
<img src="Figuras/map_simple.png" alt="Representação simples da tarefa executada por \texttt{map\_dbl()}" width="70%"><p class="caption">
Figura 16.1: Representação simples da tarefa executada por
</p>
</div>
<p></p>
<p>Portanto, no exemplo anterior, em que aplicamos a função <code><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl()</a></code> sobre o objeto <code>tab</code>, o que <code><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl()</a></code> fez, foi criar um <em>loop</em> para aplicar as funções <code><a href="https://rdrr.io/r/base/mean.html">mean()</a></code> e <code><a href="https://rdrr.io/r/stats/median.html">median()</a></code> sobre cada elemento de <code>tab</code>. Como <code>tab</code> é um <code>data.frame</code>, cada elemento desse objeto corresponde a uma coluna do <code>data.frame</code>. A medida em que as funções <code><a href="https://rdrr.io/r/base/mean.html">mean()</a></code> e <code><a href="https://rdrr.io/r/stats/median.html">median()</a></code> foram sendo aplicadas sobre cada coluna de <code>tab</code>, a função <code><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl()</a></code> foi coletando e armazenando os seus resultados em um vetor atômico do tipo <code>double</code>. Por fim, a função <code><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl()</a></code> nos retorna como <em>output</em>, este vetor atômico contendo todos os resultados gerados. A figura 16.2 abaixo, apresenta esse processo de forma mais detalhada.</p>
<p></p>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:unnamed-chunk-873"></span>
<img src="Figuras/map.png" alt="Representação mais detalhada da tarefa executada por \texttt{map\_dbl()}" width="100%"><p class="caption">
Figura 16.2: Representação mais detalhada da tarefa executada por
</p>
</div>
<p></p>
</div>
<div id="no-fundo-estamos-utilizando-um-for-loop" class="section level3" number="16.2.2">
<h3>
<span class="header-section-number">16.2.2</span> No fundo, estamos utilizando um <code>for</code> <em>loop</em><a class="anchor" aria-label="anchor" href="#no-fundo-estamos-utilizando-um-for-loop"><i class="fas fa-link"></i></a>
</h3>
<p>No fim das contas, todas as funções <code>map</code> utilizam em algum momento um <code>for</code> <em>loop</em> para aplicar a função <code>.f</code> sobre cada elemento do objeto <code>.x</code>. Um detalhe é que essas funções constroem esse <code>for</code> <em>loop</em> em C, com o objetivo de gerar máxima performance. A título de ilustração, poderíamos reproduzir em R a definição da função <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code>, da seguinte forma:</p>
<p></p>
<div class="sourceCode" id="cb1645"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">map</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">.x</span>, <span class="va">.f</span>, <span class="va">...</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">resultados</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span><span class="st">"list"</span>, length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">resultados</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">.f</span><span class="op">(</span><span class="va">.x</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, <span class="va">...</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">resultados</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">tab</span>, <span class="va">mean</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [[1]]
## [1] -0.5262096
## 
## [[2]]
## [1] 0.4976089
## 
## [[3]]
## [1] 0.2400317
## 
## [[4]]
## [1] -0.02559521</code></pre>
<p></p>
<p>Com essa definição em mente, você também pode rapidamente atribuir as diferenças entre as funções <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code>, <code><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl()</a></code>, e todas as demais funções <code>map</code>, à primeira linha dessa definição com a função <code><a href="https://rdrr.io/r/base/vector.html">vector()</a></code>. Ou seja, a diferença principal entre as funções <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> e <code><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl()</a></code> (ou qualquer outra das funções <code>map</code>) é o tipo de vetor criado pela função <code><a href="https://rdrr.io/r/base/vector.html">vector()</a></code>. Tal diferença está marcada na figura 16.3.</p>
<p></p>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:unnamed-chunk-876"></span>
<img src="Figuras/dif_map.png" alt="Diferenças entre as definições das funções `map`" width="100%"><p class="caption">
Figura 16.3: Diferenças entre as definições das funções <code>map</code>
</p>
</div>
<p></p>
<p>Sendo assim, todas as funções <code>map</code> ainda dependem de um <code>for</code> <em>loop</em> para realizar o seu trabalho. Porém, essas funções assumem o trabalho duro de criar esse <code>for</code> <em>loop</em> por você. Como resultado, você economiza parte de seu tempo, e deixa a intenção de seu código mais clara.</p>
</div>
<div id="se-não-existe-uma-solução-pronta-no-r-crie-a-sua-própria" class="section level3" number="16.2.3">
<h3>
<span class="header-section-number">16.2.3</span> Se não existe uma solução pronta no R, crie a sua própria<a class="anchor" aria-label="anchor" href="#se-n%C3%A3o-existe-uma-solu%C3%A7%C3%A3o-pronta-no-r-crie-a-sua-pr%C3%B3pria"><i class="fas fa-link"></i></a>
</h3>
<p>Um dos grandes poderes das funções <code>map</code>, é que elas te ajudam a aplicar as suas ações sobre múltiplos <em>inputs</em> diferentes. Por “suas ações”, quero destacar que, se você não possui uma função já pronta no R que execute a ação que você deseja aplicar sobre cada elemento de seu objeto, você pode muito bem criar uma função personalizada, que aplique exatamente essa ação da forma como você deseja. Replicar depois essa função personalizada para os demais <em>inputs</em> se torna um passo muito simples com as funções <code>map</code>.</p>
<p>Por exemplo, imagine que você tenha uma lista como o objeto <code>l</code> abaixo, onde cada elemento é uma nova lista que pode conter um número variável de elementos. Agora, imagine que você queira identificar quais elementos dessa lista possuem <code>NA</code>’s. Nesse caso, você pode criar uma função como a <code>tem_na()</code> abaixo, que aceita uma lista como <em>input</em>, e utiliza as funções <code><a href="https://rdrr.io/r/base/NA.html">is.na()</a></code> e <code><a href="https://rdrr.io/r/base/any.html">any()</a></code> para descobrir se algum dos elementos dessa lista contém um valor <code>NA</code>. Em seguida, podemos simplesmente replicar essa função para cada elemento da lista <code>l</code> com a função <code><a href="https://purrr.tidyverse.org/reference/map.html">map_lgl()</a></code>.</p>
<p></p>
<div class="sourceCode" id="cb1647"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tem_na</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">teste</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="va">resultado</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="va">teste</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">resultado</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">l</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="cn">NA</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fl">24</span>, <span class="fl">12</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fl">21</span>, <span class="cn">NA</span>, <span class="fl">4</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fl">56</span>, <span class="fl">19</span>, <span class="fl">20</span>, <span class="fl">43</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">vec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_lgl</a></span><span class="op">(</span><span class="va">l</span>, <span class="va">tem_na</span><span class="op">)</span></span>
<span><span class="va">vec</span></span></code></pre></div>
<pre><code>## [1]  TRUE FALSE  TRUE FALSE</code></pre>
<p></p>
</div>
<div id="alguns-atalhos-úteis-das-funções-map" class="section level3" number="16.2.4">
<h3>
<span class="header-section-number">16.2.4</span> Alguns atalhos úteis das funções <code>map</code><a class="anchor" aria-label="anchor" href="#alguns-atalhos-%C3%BAteis-das-fun%C3%A7%C3%B5es-map"><i class="fas fa-link"></i></a>
</h3>
<p>Existem alguns atalhos úteis que você pode utilizar ao definir o argumento <code>.f</code> nas funções <code>map</code>. Por exemplo, suponha que você possua uma lista com várias informações referentes a um determinado aluno. Caso você precise coletar as idades de cada aluno em um vetor atômico por exemplo, você poderia fornecer à função <code><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl()</a></code>, uma função anônima responsável por extrair o item <code>idade</code> de uma lista de <em>input</em>, como demonstrado abaixo.</p>
<p></p>
<div class="sourceCode" id="cb1649"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">alunos</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>  Ana <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>idade <span class="op">=</span> <span class="fl">15</span>, altura <span class="op">=</span> <span class="fl">1.67</span><span class="op">)</span>,</span>
<span>  Bruno <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>idade <span class="op">=</span> <span class="fl">17</span>, altura <span class="op">=</span> <span class="fl">1.75</span><span class="op">)</span>,</span>
<span>  Amanda <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>idade <span class="op">=</span> <span class="fl">21</span>, altura <span class="op">=</span> <span class="fl">1.88</span><span class="op">)</span>,</span>
<span>  Eduardo <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>idade <span class="op">=</span> <span class="fl">14</span>, altura <span class="op">=</span> <span class="fl">1.62</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">alunos</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">idade</span><span class="op">)</span></span></code></pre></div>
<pre><code>##     Ana   Bruno  Amanda Eduardo 
##      15      17      21      14</code></pre>
<p></p>
<p>Apesar de bem prático escrevermos uma função anônima dessa forma, podemos utilizar uma notação ainda mais simples. Tal notação consiste em utilizar um til (<code>~</code>) como uma abreviação para a declaração da função anônima, e um ponto final (<code>.</code>) para determinar onde o argumento será posicionado no corpo dessa função anônima. Tendo isso em mente, poderíamos reproduzir o exemplo acima, da seguinte forma:</p>
<p></p>
<div class="sourceCode" id="cb1651"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">alunos</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl</a></span><span class="op">(</span><span class="op">~</span><span class="va">.</span><span class="op">$</span><span class="va">idade</span><span class="op">)</span></span></code></pre></div>
<pre><code>##     Ana   Bruno  Amanda Eduardo 
##      15      17      21      14</code></pre>
<p></p>
<p>Portanto, o til substitui de certa forma a palavra-chave <code>function</code>, e o ponto final representa o argumento da função, ou, o elemento sobre o qual a função será aplicada. Contudo, como esse processo de extrair informações específicas de uma lista é algo muito comum, as funções <code>map</code> também oferecem um outro atalho, que seria o uso de uma <em>string</em>. Logo, se você deseja extrair um item de uma lista presente em cada elemento de um objeto, você pode simplesmente fornecer o nome desse item em uma <em>string</em> à função <code>map</code>.</p>
<p></p>
<div class="sourceCode" id="cb1653"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">alunos</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl</a></span><span class="op">(</span><span class="st">"idade"</span><span class="op">)</span></span></code></pre></div>
<pre><code>##     Ana   Bruno  Amanda Eduardo 
##      15      17      21      14</code></pre>
<p></p>
</div>
</div>
<div id="um-estudo-de-caso-aplicando-um-modelo-econométrico-sobre-diferentes-países" class="section level2" number="16.3">
<h2>
<span class="header-section-number">16.3</span> Um estudo de caso: aplicando um modelo econométrico sobre diferentes países<a class="anchor" aria-label="anchor" href="#um-estudo-de-caso-aplicando-um-modelo-econom%C3%A9trico-sobre-diferentes-pa%C3%ADses"><i class="fas fa-link"></i></a>
</h2>
<p>Nessa seção, vamos reproduzir o famoso exemplo dado por Hadley Wickham em sua palestra <em>“Managing many models with R”</em>. Pois esse exemplo demonstra bem, como as funções <code>map</code> ampliam as nossas capacidades com a linguagem R. Tal exemplo, começa pelo dataset <code>gapminder</code>, disponível através do pacote <code>gapminder</code>. Esse dataset contém dados de expectativa de vida (<code>lifeExp</code>), população (<code>pop</code>) e PIB per capita (<code>gdpPercap</code>) de diversos países do mundo (<code>country</code>), ao longo de vários anos (<code>year</code>).</p>
<p></p>
<div class="sourceCode" id="cb1655"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jennybc/gapminder">gapminder</a></span><span class="op">)</span></span></code></pre></div>
<p></p>
<p></p>
<div class="sourceCode" id="cb1656"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gapminder</span></span></code></pre></div>
<pre><code>## # A tibble: 1,704 × 6
##    country     continent  year lifeExp      pop gdpPercap
##    &lt;fct&gt;       &lt;fct&gt;     &lt;int&gt;   &lt;dbl&gt;    &lt;int&gt;     &lt;dbl&gt;
##  1 Afghanistan Asia       1952    28.8  8425333      779.
##  2 Afghanistan Asia       1957    30.3  9240934      821.
##  3 Afghanistan Asia       1962    32.0 10267083      853.
##  4 Afghanistan Asia       1967    34.0 11537966      836.
##  5 Afghanistan Asia       1972    36.1 13079460      740.
##  6 Afghanistan Asia       1977    38.4 14880372      786.
##  7 Afghanistan Asia       1982    39.9 12881816      978.
##  8 Afghanistan Asia       1987    40.8 13867957      852.
##  9 Afghanistan Asia       1992    41.7 16317921      649.
## 10 Afghanistan Asia       1997    41.8 22227415      635.
## # … with 1,694 more rows</code></pre>
<p></p>
<p>Repare abaixo, que esse dataset contém dados de 142 países diferentes, ao longo de 5 continentes do mundo. Dentre esses vários países, temos uma expectativa de vida estimada que varia de 23,59 até 82,60 anos, e um PIB per capita de 241 até 113.523 dólares.</p>
<p></p>
<div class="sourceCode" id="cb1658"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/n_distinct.html">n_distinct</a></span><span class="op">(</span><span class="va">gapminder</span><span class="op">$</span><span class="va">country</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 142</code></pre>
<div class="sourceCode" id="cb1660"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/n_distinct.html">n_distinct</a></span><span class="op">(</span><span class="va">gapminder</span><span class="op">$</span><span class="va">continent</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 5</code></pre>
<div class="sourceCode" id="cb1662"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/range.html">range</a></span><span class="op">(</span><span class="va">gapminder</span><span class="op">$</span><span class="va">lifeExp</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 23.599 82.603</code></pre>
<div class="sourceCode" id="cb1664"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/range.html">range</a></span><span class="op">(</span><span class="va">gapminder</span><span class="op">$</span><span class="va">gdpPercap</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1]    241.1659 113523.1329</code></pre>
<p></p>
<p>Com esses dados em mãos, podemos utilizar um modelo econométrico para tentar explicar a expectativa de vida da população de cada país com base no seu PIB per capita. Essa é uma hipótese clássica da literatura econômica, que se baseia na ideia de que um povo vive melhor e por mais tempo, quando ele possui uma maior capacidade de adquirir bens e serviços. Tal modelo econométrico está apresentado abaixo, onde <span class="math inline">\(lifeExp_j\)</span> representa a expectativa de vida estimada para o país <span class="math inline">\(j\)</span>, e <span class="math inline">\(gdpPercap_j\)</span>, o PIB per capita observado para o mesmo país <span class="math inline">\(j\)</span>.</p>
<p><span class="math display">\[lifeExp_j= \beta_{0} + \beta_{1} \times gdpPercap_j\]</span></p>
<p>Caso você nunca tenha visto ou estudado sobre econometria (também conhecida como “análise de regressão linear”), não se preocupe em entender exatamente como o modelo é calculado, ou o que a equação acima representa. Se preocupe apenas em entender os seguintes pontos: 1) a função <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code> é uma função presente nos pacotes básicos do R, que é capaz de calcular esse tipo de modelo; 2) precisamos aplicar essa função <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code> sobre os dados de cada país, para obtermos os resultados do modelo separados para cada país.</p>
<p>Como um primeiro exemplo, para aplicarmos esse modelo econométrico sobre os dados de um país em específico, como o Brasil, poderíamos fazer o seguinte:</p>
<p></p>
<div class="sourceCode" id="cb1666"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">br</span> <span class="op">&lt;-</span> <span class="va">gapminder</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">country</span> <span class="op">==</span> <span class="st">"Brazil"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">modelo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">lifeExp</span> <span class="op">~</span> <span class="va">gdpPercap</span>, data <span class="op">=</span> <span class="va">br</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">modelo</span><span class="op">)</span></span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = lifeExp ~ gdpPercap, data = br)
## 
## Residuals:
##    Min     1Q Median     3Q    Max 
## -3.066 -1.278  0.367  1.335  2.350 
## 
## Coefficients:
##              Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept) 4.599e+01  1.510e+00   30.46 3.41e-11 ***
## gdpPercap   2.787e-03  2.405e-04   11.59 4.04e-07 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 1.943 on 10 degrees of freedom
## Multiple R-squared:  0.9307, Adjusted R-squared:  0.9238 
## F-statistic: 134.4 on 1 and 10 DF,  p-value: 4.045e-07</code></pre>
<p></p>
<p>Portanto, no exemplo acima, o objeto <code>modelo</code> contém os resultados do modelo para o Brasil. Pois aplicamos a função <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code> especificamente sobre os dados do Brasil. Todavia, caso aplicássemos a função <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code> diretamente sobre a tabela <code>gapminder</code> inteira, teríamos na verdade, os resultados do modelo para todo o mundo (sem distinção de países). Pois estamos utilizando os dados de todos os países ao mesmo tempo para calcular o modelo.</p>
<p></p>
<div class="sourceCode" id="cb1668"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">### Abaixo temos os resultados do modelo para</span></span>
<span><span class="co">### todo o mundo. Pois aplicamos a função lm() sobre</span></span>
<span><span class="co">### os dados de todos os países de uma vez só.</span></span>
<span><span class="va">modelo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">lifeExp</span> <span class="op">~</span> <span class="va">gdpPercap</span>, data <span class="op">=</span> <span class="va">gapminder</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">modelo</span><span class="op">)</span></span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = lifeExp ~ gdpPercap, data = gapminder)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -82.754  -7.758   2.176   8.225  18.426 
## 
## Coefficients:
##              Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept) 5.396e+01  3.150e-01  171.29   &lt;2e-16 ***
## gdpPercap   7.649e-04  2.579e-05   29.66   &lt;2e-16 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 10.49 on 1702 degrees of freedom
## Multiple R-squared:  0.3407, Adjusted R-squared:  0.3403 
## F-statistic: 879.6 on 1 and 1702 DF,  p-value: &lt; 2.2e-16</code></pre>
<p></p>
<p>Agora, como poderíamos calcular os resultados desse modelo separados para cada um dos 142 países descritos em <code>gapminder</code>? Com a ajuda das funções <code>map</code>, replicar esse modelo para os 142 países, se torna uma tarefa extremamente simples de ser feita.</p>
<p>Pelo fato da função <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> aplicar uma determinada função sobre cada elemento de um objeto, podemos utilizar <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> para aplicarmos <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code> sobre os dados de cada país. Sendo assim, cada elemento do objeto utilizado por <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code>, deve conter os dados de um país específico. Logo, cada elemento deste objeto seria muito provavelmente um <code>data.frame</code> contendo os dados de um país.</p>
<p>Dito de outra forma, vamos aplicar a função <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> sobre uma lista de <code>data.frame</code>’s. Por esse motivo, a função que <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> vai aplicar sobre cada elemento dessa lista, deve aceitar como <em>input</em>, um <code>data.frame</code> contendo os dados de um país específico, e gerar como <em>output</em>, os resultados do modelo aplicado sobre esses dados de <em>input</em>. Como primeiro passo, vamos criar essa função.</p>
<div id="a-função-que-calcula-o-modelo-econométrico" class="section level3" number="16.3.1">
<h3>
<span class="header-section-number">16.3.1</span> A função que calcula o modelo econométrico<a class="anchor" aria-label="anchor" href="#a-fun%C3%A7%C3%A3o-que-calcula-o-modelo-econom%C3%A9trico"><i class="fas fa-link"></i></a>
</h3>
<p>Portanto, precisamos criar uma função que aceita um <code>data.frame</code> como <em>input</em>, e que calcula o modelo econométrico sobre os dados desse <em>input</em>. A função <code>aplicar_modelo()</code> abaixo, cumpre justamente esse papel. Tudo que essa função faz é aplicar a função <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code> sobre o <code>data.frame</code> de <em>input</em> (argumento <code>x</code>). Perceba também que, independente de qual for o <code>data.frame</code> que fornecermos a essa função, ela vai sempre calcular o mesmo modelo, pois a equação na função <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code> sempre será <code>lifeExp ~ gdpPercap</code>.</p>
<p></p>
<div class="sourceCode" id="cb1670"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">aplicar_modelo</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">lifeExp</span> <span class="op">~</span> <span class="va">gdpPercap</span>, data <span class="op">=</span> <span class="va">x</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p></p>
</div>
<div id="criando-uma-lista-de-data.frames" class="section level3" number="16.3.2">
<h3>
<span class="header-section-number">16.3.2</span> Criando uma lista de <code>data.frame</code>’s<a class="anchor" aria-label="anchor" href="#criando-uma-lista-de-data.frames"><i class="fas fa-link"></i></a>
</h3>
<p>Podemos criar a lista de <code>data.frame</code>’s, contendo os dados de cada país, de diversas formas. Em sua palestra, Hadley Wickham utilizou a função <code><a href="https://tidyr.tidyverse.org/reference/nest.html">nest()</a></code>, proveniente do pacote <code>tidyr</code>, para criar essa lista de <code>data.frame</code>’s dentro de uma coluna do <code>data.frame</code> original. Ou seja, Wickham utilizou <code><a href="https://tidyr.tidyverse.org/reference/nest.html">nest()</a></code> para criar uma espécie de <code>data.frame</code> de <code>data.frame</code>’s, pois ele queria demonstrar esta poderosa ideia de um <em>nested</em> <code>data.frame</code>. Porém, como uma solução ainda mais simples, também poderíamos utilizar a função <code><a href="https://rdrr.io/r/base/split.html">split()</a></code> para dividirmos a tabela <code>gapminder</code> em uma lista, onde cada elemento dessa lista conteria um <code>data.frame</code> com os dados de um país diferente. Ambas as soluções são perfeitamente válidas.</p>
</div>
<div id="com-a-função-split" class="section level3" number="16.3.3">
<h3>
<span class="header-section-number">16.3.3</span> Com a função <code>split()</code><a class="anchor" aria-label="anchor" href="#com-a-fun%C3%A7%C3%A3o-split"><i class="fas fa-link"></i></a>
</h3>
<p>Precisamos separar em diferentes elementos, os dados de cada país descrito na tabela <code>gapminder</code>. Para isso, podemos utilizar a função <code><a href="https://rdrr.io/r/base/split.html">split()</a></code>. Em resumo, essa função aceita um vetor ou <code>data.frame</code> como <em>input</em>, e divide esse objeto de <em>input</em> em diferentes elementos de uma lista, com base em algum vetor de grupos.</p>
<p>Logo, podemos pedir à <code><a href="https://rdrr.io/r/base/split.html">split()</a></code> que divida a tabela <code>gapminder</code> de acordo com os valores da coluna <code>country</code>. Veja o resultado abaixo:</p>
<p></p>
<div class="sourceCode" id="cb1671"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dados_por_pais</span> <span class="op">&lt;-</span> <span class="va">gapminder</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/split.html">split</a></span><span class="op">(</span><span class="op">~</span><span class="va">country</span><span class="op">)</span></span>
<span><span class="va">dados_por_pais</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<pre><code>## # A tibble: 12 × 6
##    country     continent  year lifeExp      pop gdpPercap
##    &lt;fct&gt;       &lt;fct&gt;     &lt;int&gt;   &lt;dbl&gt;    &lt;int&gt;     &lt;dbl&gt;
##  1 Afghanistan Asia       1952    28.8  8425333      779.
##  2 Afghanistan Asia       1957    30.3  9240934      821.
##  3 Afghanistan Asia       1962    32.0 10267083      853.
##  4 Afghanistan Asia       1967    34.0 11537966      836.
##  5 Afghanistan Asia       1972    36.1 13079460      740.
##  6 Afghanistan Asia       1977    38.4 14880372      786.
##  7 Afghanistan Asia       1982    39.9 12881816      978.
##  8 Afghanistan Asia       1987    40.8 13867957      852.
##  9 Afghanistan Asia       1992    41.7 16317921      649.
## 10 Afghanistan Asia       1997    41.8 22227415      635.
## 11 Afghanistan Asia       2002    42.1 25268405      727.
## 12 Afghanistan Asia       2007    43.8 31889923      975.</code></pre>
<p></p>
<p>Portanto, o objeto <code>dados_por_pais</code> é uma lista, onde cada elemento dessa lista, contém um <code>data.frame</code> com os dados de um país específico. Agora, podemos utilizar a função <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> para simplesmente aplicarmos a função <code>aplicar_modelo()</code> sobre cada elemento dessa lista, ou, sobre os dados de cada país. Como resultado, teremos uma nova lista, onde cada elemento dessa lista, contém os resultados do modelo para um determinado país. No exemplo abaixo, estou mostrando os resultados do modelo para o Afeganistão. Curiosamente, o coeficiente estimado pelo modelo foi negativo (-0,00224), indicando assim, que para o Afeganistão, aumentos no PIB per capita reduzem a expectativa de vida estimada da população. Um resultado que contradiz a nossa hipótese inicial.</p>
<p></p>
<div class="sourceCode" id="cb1673"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">modelos</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">dados_por_pais</span>, <span class="va">aplicar_modelo</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">modelos</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = lifeExp ~ gdpPercap, data = x)
## 
## Residuals:
##    Min     1Q Median     3Q    Max 
## -8.730 -3.880  1.845  3.866  6.734 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)   
## (Intercept) 39.27720   12.04623   3.261  0.00857 **
## gdpPercap   -0.00224    0.01488  -0.151  0.88334   
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 5.341 on 10 degrees of freedom
## Multiple R-squared:  0.002261,   Adjusted R-squared:  -0.09751 
## F-statistic: 0.02266 on 1 and 10 DF,  p-value: 0.8833</code></pre>
<p></p>
<p>Com a lista <code>modelos</code>, podemos continuar utilizando a função <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> para extrair informações específicas desses modelos. Por exemplo, os comandos abaixo utilizam a função <code>glance()</code> do pacote <code>broom</code> para extrair o <span class="math inline">\(R^2\)</span> (coeficiente de determinação) estimado por cada modelo. No exemplo abaixo, estou mostrando os coeficientes dos 10 primeiros países.</p>
<p></p>
<div class="sourceCode" id="cb1675"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r2s</span> <span class="op">&lt;-</span> <span class="va">modelos</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="fu">broom</span><span class="fu">::</span><span class="va"><a href="https://generics.r-lib.org/reference/glance.html">glance</a></span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl</a></span><span class="op">(</span><span class="st">"r.squared"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">r2s</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span></span></code></pre></div>
<pre><code>## Afghanistan     Albania     Algeria      Angola   Argentina   Australia 
## 0.002260718 0.700762689 0.818067786 0.090648834 0.691638237 0.973075112 
##     Austria     Bahrain  Bangladesh     Belgium 
## 0.985977854 0.806033051 0.717947961 0.985551840</code></pre>
<p></p>
</div>
<div id="com-a-função-nest" class="section level3" number="16.3.4">
<h3>
<span class="header-section-number">16.3.4</span> Com a função <code>nest()</code><a class="anchor" aria-label="anchor" href="#com-a-fun%C3%A7%C3%A3o-nest"><i class="fas fa-link"></i></a>
</h3>
<p>Apesar da função <code><a href="https://rdrr.io/r/base/split.html">split()</a></code> já nos oferecer uma ótima solução, também podemos muito bem adotar a solução mostrada por Wickham, que utiliza a função <code><a href="https://tidyr.tidyverse.org/reference/nest.html">nest()</a></code> para criar um “<code>data.frame</code> de <code>data.frame</code>’s”.</p>
<p>No momento, cada linha da tabela <code>gapminder</code> descreve os dados de um país em um determinado ano. Entretanto, a nossa intenção com essa solução, é transformar a tabela <code>gapminder</code>, de modo que cada linha da tabela contenha todos os dados de um determinado país para todos os anos. Podemos realizar essa transformação, ao agruparmos à tabela pela coluna <code>country</code> (com a função <code><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by()</a></code>) e, em seguida, aplicarmos a função <code><a href="https://tidyr.tidyverse.org/reference/nest.html">nest()</a></code> do pacote <code>tidyr</code>, como demonstrado abaixo:</p>
<p></p>
<div class="sourceCode" id="cb1677"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org">magrittr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span></span></code></pre></div>
<p></p>
<p></p>
<div class="sourceCode" id="cb1678"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dados_por_pais</span> <span class="op">&lt;-</span> <span class="va">gapminder</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">country</span>, <span class="va">continent</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">nest</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dados_por_pais</span></span></code></pre></div>
<pre><code>## # A tibble: 142 × 3
## # Groups:   country, continent [142]
##    country     continent data             
##    &lt;fct&gt;       &lt;fct&gt;     &lt;list&gt;           
##  1 Afghanistan Asia      &lt;tibble [12 × 4]&gt;
##  2 Albania     Europe    &lt;tibble [12 × 4]&gt;
##  3 Algeria     Africa    &lt;tibble [12 × 4]&gt;
##  4 Angola      Africa    &lt;tibble [12 × 4]&gt;
##  5 Argentina   Americas  &lt;tibble [12 × 4]&gt;
##  6 Australia   Oceania   &lt;tibble [12 × 4]&gt;
##  7 Austria     Europe    &lt;tibble [12 × 4]&gt;
##  8 Bahrain     Asia      &lt;tibble [12 × 4]&gt;
##  9 Bangladesh  Asia      &lt;tibble [12 × 4]&gt;
## 10 Belgium     Europe    &lt;tibble [12 × 4]&gt;
## # … with 132 more rows</code></pre>
<p></p>
<p>Dessa vez, o objeto <code>dados_por_pais</code> é um <code>data.frame</code> que contém três colunas (<code>country</code>, <code>continent</code> e <code>data</code>). A coluna <code>data</code> é uma lista, e cada elemento dessa lista contém um novo <code>data.frame</code>, que por sua vez, contém todos os dados referentes ao país identificado na coluna <code>country</code> da tabela.</p>
<p>Ou seja, ainda estamos utilizando uma lista de <code>data.frame</code>’s, onde cada <code>data.frame</code> dessa lista contém os dados de um país específico. A diferença agora, é que essa lista está inserida em uma coluna de um <code>data.frame</code>, ao invés de estar em um objeto separado.</p>
<p>Portanto, a figura 16.4 abaixo apresenta de forma gráfica a transformação executada por <code><a href="https://tidyr.tidyverse.org/reference/nest.html">nest()</a></code>. Repare também, que o pacote <code>tidyr</code> nos oferece a função <code><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest()</a></code>, com a qual podemos reverter a transformação executada por <code><a href="https://tidyr.tidyverse.org/reference/nest.html">nest()</a></code>.</p>
<p></p>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:unnamed-chunk-893"></span>
<img src="Figuras/nest.png" alt="Transformação executada por `nest()`" width="100%"><p class="caption">
Figura 16.4: Transformação executada por <code><a href="https://tidyr.tidyverse.org/reference/nest.html">nest()</a></code>
</p>
</div>
<p></p>
<p>Como exemplo, os dados do Brasil estão na 15° linha da tabela <code>dados_por_pais</code>. Logo, eu posso adquirir todos os dados do Brasil, ao acessar o 15° elemento da coluna <code>data</code>. Perceba abaixo, que um novo <code>data.frame</code> é retornado, que contém todos os dados referentes ao Brasil.</p>
<p></p>
<div class="sourceCode" id="cb1680"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dados_por_pais</span><span class="op">$</span><span class="va">data</span><span class="op">[[</span><span class="fl">15</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<pre><code>## # A tibble: 12 × 4
##     year lifeExp       pop gdpPercap
##    &lt;int&gt;   &lt;dbl&gt;     &lt;int&gt;     &lt;dbl&gt;
##  1  1952    50.9  56602560     2109.
##  2  1957    53.3  65551171     2487.
##  3  1962    55.7  76039390     3337.
##  4  1967    57.6  88049823     3430.
##  5  1972    59.5 100840058     4986.
##  6  1977    61.5 114313951     6660.
##  7  1982    63.3 128962939     7031.
##  8  1987    65.2 142938076     7807.
##  9  1992    67.1 155975974     6950.
## 10  1997    69.4 168546719     7958.
## 11  2002    71.0 179914212     8131.
## 12  2007    72.4 190010647     9066.</code></pre>
<p></p>
<p>Agora, precisamos apenas aplicar a função <code>aplicar_modelo()</code> sobre cada elemento da coluna <code>data</code>. Para isso, podemos utilizar novamente a função <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code>, dessa vez, dentro da função <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> que introduzimos no capítulo 4. Dessa maneira, <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> vai executar a função <code>aplicar_modelo()</code> para cada elemento da coluna <code>data</code>, e retornar uma lista com os resultados, e a função <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> vai adicionar essa lista como uma nova coluna do <code>data.frame</code>.</p>
<p></p>
<div class="sourceCode" id="cb1682"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">modelos</span> <span class="op">&lt;-</span> <span class="va">dados_por_pais</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    resultados <span class="op">=</span> <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">aplicar_modelo</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">modelos</span></span></code></pre></div>
<pre><code>## # A tibble: 142 × 4
## # Groups:   country, continent [142]
##    country     continent data              resultados
##    &lt;fct&gt;       &lt;fct&gt;     &lt;list&gt;            &lt;list&gt;    
##  1 Afghanistan Asia      &lt;tibble [12 × 4]&gt; &lt;lm&gt;      
##  2 Albania     Europe    &lt;tibble [12 × 4]&gt; &lt;lm&gt;      
##  3 Algeria     Africa    &lt;tibble [12 × 4]&gt; &lt;lm&gt;      
##  4 Angola      Africa    &lt;tibble [12 × 4]&gt; &lt;lm&gt;      
##  5 Argentina   Americas  &lt;tibble [12 × 4]&gt; &lt;lm&gt;      
##  6 Australia   Oceania   &lt;tibble [12 × 4]&gt; &lt;lm&gt;      
##  7 Austria     Europe    &lt;tibble [12 × 4]&gt; &lt;lm&gt;      
##  8 Bahrain     Asia      &lt;tibble [12 × 4]&gt; &lt;lm&gt;      
##  9 Bangladesh  Asia      &lt;tibble [12 × 4]&gt; &lt;lm&gt;      
## 10 Belgium     Europe    &lt;tibble [12 × 4]&gt; &lt;lm&gt;      
## # … with 132 more rows</code></pre>
<p></p>
<p>Agora, cada elemento da coluna <code>resultados</code> contém todos os resultados do modelo para cada país da tabela <code>gapminder</code>. A partir daqui, podemos utilizar novamente as funções <code>map</code> para extrairmos as informações específicas dos modelos. Por exemplo, podemos extrair o beta estimado (<span class="math inline">\(\beta_1\)</span>) e o coeficiente de determinação de cada país, e adicioná-los como novas colunas da tabela modelos.</p>
<p></p>
<div class="sourceCode" id="cb1684"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">modelos</span> <span class="op">&lt;-</span> <span class="va">modelos</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    glance <span class="op">=</span> <span class="va">resultados</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="fu">broom</span><span class="fu">::</span><span class="va"><a href="https://generics.r-lib.org/reference/glance.html">glance</a></span><span class="op">)</span>,</span>
<span>    tidy <span class="op">=</span> <span class="va">resultados</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="fu">broom</span><span class="fu">::</span><span class="va"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op">)</span>,</span>
<span>    beta_estimado <span class="op">=</span> <span class="va">tidy</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl</a></span><span class="op">(</span><span class="op">~</span><span class="va">.</span><span class="op">[[</span><span class="st">"estimate"</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>,</span>
<span>    r2 <span class="op">=</span> <span class="va">glance</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl</a></span><span class="op">(</span><span class="st">"r.squared"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">glance</span>, <span class="op">-</span><span class="va">tidy</span><span class="op">)</span></span>
<span></span>
<span><span class="va">modelos</span></span></code></pre></div>
<pre><code>## # A tibble: 142 × 6
## # Groups:   country, continent [142]
##    country     continent data              resultados beta_estimado      r2
##    &lt;fct&gt;       &lt;fct&gt;     &lt;list&gt;            &lt;list&gt;             &lt;dbl&gt;   &lt;dbl&gt;
##  1 Afghanistan Asia      &lt;tibble [12 × 4]&gt; &lt;lm&gt;           -0.00224  0.00226
##  2 Albania     Europe    &lt;tibble [12 × 4]&gt; &lt;lm&gt;            0.00444  0.701  
##  3 Algeria     Africa    &lt;tibble [12 × 4]&gt; &lt;lm&gt;            0.00714  0.818  
##  4 Angola      Africa    &lt;tibble [12 × 4]&gt; &lt;lm&gt;           -0.00103  0.0906 
##  5 Argentina   Americas  &lt;tibble [12 × 4]&gt; &lt;lm&gt;            0.00187  0.692  
##  6 Australia   Oceania   &lt;tibble [12 × 4]&gt; &lt;lm&gt;            0.000524 0.973  
##  7 Austria     Europe    &lt;tibble [12 × 4]&gt; &lt;lm&gt;            0.000450 0.986  
##  8 Bahrain     Asia      &lt;tibble [12 × 4]&gt; &lt;lm&gt;            0.00142  0.806  
##  9 Bangladesh  Asia      &lt;tibble [12 × 4]&gt; &lt;lm&gt;            0.0325   0.718  
## 10 Belgium     Europe    &lt;tibble [12 × 4]&gt; &lt;lm&gt;            0.000447 0.986  
## # … with 132 more rows</code></pre>
<p></p>
<p>Com esses resultados em mãos, podemos criar visualizações muito interessantes. Como o gráfico de dispersão abaixo, que apresenta a relação entre o beta estimado e o coeficiente de determinação do modelo. Repare nesse gráfico, que os países da Europa, em geral, possuem um beta estimado baixo, indicando assim, que aumentos no PIB per capita tem baixos impactos na expectativa de vida. Isso provavelmente ocorre, porque esses países já possuem expectativas de vida relativamente altas.</p>
<p>Por outro lado, perceba também que os países africanos parecem se concentrar nos dois extremos do gráfico, com os maiores e menores betas estimados. Os maiores betas, indicam que aumentos no PIB per capita trazem fortes impactos positivos sobre as expectativas de vida nesses países. Isso provavelmente se deve à vida precária e a baixa expectativa de vida que a população desses países enfrenta, de modo que, uma melhoria mínima pode trazer grandes impactos positivos nas condições de vida dessas populações.</p>
<p>Para mais, repare que os países africanos que possuem betas estimados negativos também possuem coeficientes de determinação baixos, indicando assim, um baixo poder explicativo do modelo. Isso é um sinal de que o nosso modelo não consegue explicar muito dos dados desses países, e provavelmente, esse baixo poder explicativo gerou um beta estimado negativo, que é algo inesperado para essa relação entre expectativa de vida e renda per capita.</p>
<p>Talvez, esses países tem características importantes que os outros países não possuem, e que afetam essa relação econômica. Por exemplo, muitos países africanos enfrentam guerras civis recorrentes. Guerras desse tipo geram impactos negativos na expectativa de vida, e as mortes podem gerar quedas na população total do país, o que resultaria em um aumento do PIB per capita (<em>ceteris paribus</em>).</p>
<p></p>
<div class="sourceCode" id="cb1686"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">modelos</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">r2</span>, y <span class="op">=</span> <span class="va">beta_estimado</span>, color <span class="op">=</span> <span class="va">continent</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<embed src="Introducao_R_files/figure-html/unnamed-chunk-897-1.pdf" width="60%" style="display: block; margin: auto;" type="application/pdf"></embed><p></p>
</div>
</div>
<div id="comparando-a-família-map-à-família-apply" class="section level2" number="16.4">
<h2>
<span class="header-section-number">16.4</span> Comparando a família <code>map</code> à família <code>apply</code><a class="anchor" aria-label="anchor" href="#comparando-a-fam%C3%ADlia-map-%C3%A0-fam%C3%ADlia-apply"><i class="fas fa-link"></i></a>
</h2>
<p>Os pacotes básicos do R, nos oferecem a família <code>apply</code> de funções, a qual desenvolve um papel muito similar às funções <code>map</code>. Os membros dessa família estão listados abaixo:</p>
<ul>
<li>
<code>apply</code> (<em>generic apply</em>): retorna diferentes tipos de estrutura a depender de um conjunto de condições.</li>
<li>
<code>lapply</code> (<em>list apply</em>): retorna uma lista.</li>
<li>
<code>sapply</code> (<em>simple apply</em>): tenta simplificar o resultado para uma estrutura mais “simples”, a depender do comprimento de cada resultado gerado por <code>FUN</code>.</li>
<li>
<code>vapply</code> (<em>vector apply</em>): retorna um vetor de mesmo tipo de dado que o vetor definido no argumento <code>FUN.VALUE</code>.</li>
</ul>
<p>Tendo isso em mente, todas essas funções aceitam um objeto (<code>X</code>) e uma função (<code>FUN</code>) em seus dois primeiros argumentos. Essas funções <code>apply</code> vão aplicar a função <code>FUN</code> sobre cada elemento do objeto <code>X</code> fornecido, e retornar como resultado, um novo objeto contendo todos os resultados gerados pela função <code>FUN</code> aplicada sobre cada elemento do objeto <code>X</code>.</p>
<p>Um dos principais motivos pelos quais a família <code>apply</code> tem perdido espaço para a família <code>map</code>, é pelo fato dessas funções serem menos consistentes, especialmente quanto à estrutura do resultado retornado. Por exemplo, <code><a href="https://rdrr.io/r/base/apply.html">apply()</a></code> pode retornar um vetor, um <code>array</code> ou uma lista como resultado. Para mais, as condições que determinam qual dessas estruturas é retornada por <code><a href="https://rdrr.io/r/base/apply.html">apply()</a></code> são levemente confusas. Se estiver curioso, leia a seção <code>Value</code> da documentação interna (<code><a href="https://rdrr.io/r/base/apply.html">?apply</a></code>).</p>
<p>A função <code><a href="https://rdrr.io/r/base/lapply.html">sapply()</a></code> também é um outro caso de incosistência, pois essa função altera a estrutura de dados retornada, a depender do comprimento de cada um dos resultados gerados pela função <code>FUN</code>. Isso significa que, a estrutura de dados retornada por <code><a href="https://rdrr.io/r/base/lapply.html">sapply()</a></code> é determinada por um conjunto de resultados aos quais nós não temos acesso enquanto a função não completar a sua execução. Ou seja, nós não somos capazes de prever com antecedência, qual será a estrutura retornada por <code><a href="https://rdrr.io/r/base/lapply.html">sapply()</a></code>. Isso é um problema grave, dado que ele pode gerar bugs em seu script com muita facilidade, caso você não esteja preparado para lidar com literalmente qualquer tipo de resultado possível de <code><a href="https://rdrr.io/r/base/lapply.html">sapply()</a></code>.</p>
<p>São inconsistências desse tipo, que tornaram as funções <code>map</code> o padrão utilizado pela comunidade na construção de muitos pacotes e funções. Pois as funções <code>map</code> são extremamente consistentes em seus resultados. Por esse mesmo motivo, que as funções <code><a href="https://rdrr.io/r/base/lapply.html">lapply()</a></code> e <code><a href="https://rdrr.io/r/base/lapply.html">vapply()</a></code> são exemplos de funções <code>apply</code> que ainda são muito utilizadas em diversos pacotes e funções existentes na atualidade.</p>
<p>Pois diferente de <code><a href="https://rdrr.io/r/base/apply.html">apply()</a></code> e <code><a href="https://rdrr.io/r/base/lapply.html">sapply()</a></code>, essas funções são consistentes em seus resultados. A função <code><a href="https://rdrr.io/r/base/lapply.html">lapply()</a></code> é equivalente à função <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code>, pois ela sempre lhe retorna uma lista como resultado. Já a função <code><a href="https://rdrr.io/r/base/lapply.html">vapply()</a></code> vai sempre retornar um vetor de mesmo tipo de dado que o vetor fornecido ao seu argumento <code>FUN.VALUE</code>. Ou seja, poderíamos reproduzir a função <code><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl()</a></code> com <code><a href="https://rdrr.io/r/base/lapply.html">vapply()</a></code>, ao fornecermos um vetor do tipo <code>double</code> ao seu argumento <code>FUN.VALUE</code>.</p>
<p></p>
<div class="sourceCode" id="cb1687"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">numeros</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1.5</span>, <span class="fl">2.5</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">9.8</span>, <span class="fl">1.2</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1.2</span>, <span class="fl">1.3</span>, <span class="fl">1.5</span>, <span class="fl">1.1</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">somas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">vapply</a></span><span class="op">(</span><span class="va">numeros</span>, FUN <span class="op">=</span> <span class="va">sum</span>, FUN.VALUE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html">double</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">somas</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1]  7.0 11.0  5.1</code></pre>
<p></p>
<p>Na verdade, a função <code><a href="https://rdrr.io/r/base/lapply.html">vapply()</a></code> também é capaz de retornar matrizes e arrays. Tudo depende de como você organiza o objeto fornecido ao argumento <code>FUN.VALUE</code>. Isso é um diferencial importante, que nenhuma das funções <code>map</code> são capazes de fazer até o momento.</p>
<p></p>
<div class="sourceCode" id="cb1689"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">### Retorna uma matriz</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">vapply</a></span><span class="op">(</span><span class="va">numeros</span>, FUN <span class="op">=</span> <span class="va">range</span>, FUN.VALUE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html">double</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>##      [,1] [,2] [,3]
## [1,]  1.5  1.2  1.1
## [2,]  3.0  9.8  1.5</code></pre>
<div class="sourceCode" id="cb1691"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">### Retorna um array</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">vapply</a></span><span class="op">(</span><span class="va">numeros</span>, FUN <span class="op">=</span> <span class="va">range</span>, FUN.VALUE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/double.html">double</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## , , 1, 1
## 
##      [,1] [,2]
## [1,]  1.5    3
## 
## , , 1, 2
## 
##      [,1] [,2]
## [1,]  1.2  9.8
## 
## , , 1, 3
## 
##      [,1] [,2]
## [1,]  1.1  1.5</code></pre>
<p></p>
</div>
<div id="identificando-erros-nas-funções-map" class="section level2" number="16.5">
<h2>
<span class="header-section-number">16.5</span> Identificando erros nas funções <code>map</code><a class="anchor" aria-label="anchor" href="#identificando-erros-nas-fun%C3%A7%C3%B5es-map"><i class="fas fa-link"></i></a>
</h2>
<p>A cada iteração do loop criado por <code>map</code>, estamos executando a função definida no argumento <code>.f</code>. Isso significa que, em um loop de 10 mil iterações, essa função será chamada 10 mil vezes. Isso é um detalhe importante, pois um erro pode surgir em cada uma dessas 10 mil chamadas. E caso esse erro ocorra, como você faria para identificar a sua fonte? É esse tema que vamos abordar nessa seção.</p>
<p>Vamos utilizar os comandos abaixo como exemplo. Perceba que um erro foi levantado.</p>
<p></p>
<div class="sourceCode" id="cb1693"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">valores</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>  <span class="fl">2.5</span>, <span class="fl">5.1</span>, <span class="fl">6.7</span>, <span class="fl">8.9</span>, <span class="st">"9.1"</span>, <span class="fl">0.2</span>,</span>
<span>  <span class="st">"4.4"</span>, <span class="st">"5.1"</span>, <span class="st">"7.4"</span>, <span class="fl">3.6</span>, <span class="fl">3.8</span>,</span>
<span>  <span class="fl">4.2</span>, <span class="fl">8.7</span>, <span class="fl">8.8</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">logaritmos</span> <span class="op">&lt;-</span> <span class="va">valores</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl</a></span><span class="op">(</span><span class="va">log</span><span class="op">)</span></span></code></pre></div>
<p></p>
<pre><code>Error in .Primitive("log")(x, base) :
  non-numeric argument to mathematical function</code></pre>
<p>A principal dificuldade que temos é identificar <strong>onde</strong> o erro ocorreu. Isto é, em qual das iterações esse erro ocorreu? Será que ele ocorre logo na primeira iteração do loop? Ou, talvez na última iteração? Ou ainda, ao longo de várias iterações diferentes do loop?</p>
<p>Para identificar tais pontos, poderíamos ter acesso aos resultados que foram gerados com sucesso, e aos resultados que fracassaram. Para isso, o pacote <code>purrr</code> nos provê a função <code><a href="https://purrr.tidyverse.org/reference/safely.html">safely()</a></code>.</p>
<p>Você deve aplicar essa função <code><a href="https://purrr.tidyverse.org/reference/safely.html">safely()</a></code> sobre a função <code>.f</code> que você deseja utilizar dentro de <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code>. Como resultado, <code><a href="https://purrr.tidyverse.org/reference/safely.html">safely()</a></code> gera uma nova versão da função <code>.f</code>, que é capaz de coletar os todos os resultados gerados, mesmo que eles levantem algum erro durante sua execução.</p>
<p></p>
<div class="sourceCode" id="cb1695"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">safe_log</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/safely.html">safely</a></span><span class="op">(</span><span class="va">log</span><span class="op">)</span></span>
<span><span class="va">safe_log</span></span></code></pre></div>
<pre><code>## function (...) 
## capture_error(.f(...), otherwise, quiet)
## &lt;bytecode: 0x5654bf0d2188&gt;
## &lt;environment: 0x5654bf0cc940&gt;</code></pre>
<p></p>
<p>O que essa nova versão da função faz, é sempre gerar uma lista com dois elementos (<code>result</code> e <code>error</code>) para cada <em>input</em>. O elemento <code>result</code> vai estar preenchido com o resultado da função caso ele tenha sido gerado com sucesso, enquanto o elemento <code>error</code>, estará vazio. Entretanto, caso algum erro ocorra e o resultado da função não possa ser gerado, o contrário ocorre. Ou seja, o elemento <code>result</code> estará vazio, enquanto o elemento <code>error</code> irá conter o erro que interrompeu a execução.</p>
<p>No primeiro exemplo abaixo, o elemento <code>result</code> gerado por <code>safe_log()</code> contém o valor <code>2.302585</code>, que corresponde ao resultado de <code>log(10)</code>. Isso significa que o valor da expressão <code>log(10)</code> pôde ser calculado com sucesso, sem nenhum erro encontrado. Porém, no segundo exemplo abaixo, o elemento <code>result</code> está vazio, enquanto o elemento <code>error</code> contém a mensagem de erro gerada. Logo, o resultado da expressão <code>log("a")</code> não pôde ser calculada com sucesso, pois o erro contido no elemento <code>error</code> foi levantado durante a execução.</p>
<p></p>
<div class="sourceCode" id="cb1697"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">safe_log</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## List of 2
##  $ result: num 2.3
##  $ error : NULL</code></pre>
<div class="sourceCode" id="cb1699"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">safe_log</span><span class="op">(</span><span class="st">"a"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## List of 2
##  $ result: NULL
##  $ error :List of 2
##   ..$ message: chr "non-numeric argument to mathematical function"
##   ..$ call   : language .Primitive("log")(x, base)
##   ..- attr(*, "class")= chr [1:3] "simpleError" "error" "condition"</code></pre>
<p></p>
<p>Agora, podemos simplesmente fornecer para <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> a nova função criada. Repare que dessa vez, eu estou utilizando a função <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> ao invés da função <code><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl()</a></code> para coletar os resultados gerados por <code>safe_log()</code>. Pois a função <code><a href="https://rdrr.io/r/base/Log.html">log()</a></code> gera um único valor do tipo <code>double</code> para cada <em>input</em>, já a função <code>safe_log()</code>, gera uma lista com dois elementos (<code>result</code> e <code>error</code>) para cada <em>input</em>. Como exemplo, mostro abaixo os resultados para os 3 primeiros elementos. Perceba que nenhum desses elementos levantou algum erro, dado que o elemento <code>error</code> está vazio para todos eles.</p>
<p></p>
<div class="sourceCode" id="cb1701"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">logaritmos</span> <span class="op">&lt;-</span> <span class="va">valores</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">safe_log</span><span class="op">)</span></span>
<span><span class="va">logaritmos</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## List of 3
##  $ :List of 2
##   ..$ result: num 0.916
##   ..$ error : NULL
##  $ :List of 2
##   ..$ result: num 1.63
##   ..$ error : NULL
##  $ :List of 2
##   ..$ result: num 1.9
##   ..$ error : NULL</code></pre>
<p></p>
<p>Sendo assim, para identificarmos quais elementos de <code>valores</code> são os responsáveis por levantar o erro que vimos anteriormente, podemos navegar por cada elemento de <code>logaritmos</code>, e descobrir em quais deles, o elemento <code>error</code> não está vazio.</p>
<p></p>
<div class="sourceCode" id="cb1703"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">erros</span> <span class="op">&lt;-</span> <span class="va">logaritmos</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="st">"error"</span><span class="op">)</span></span>
<span><span class="va">erro_nao_vazio</span> <span class="op">&lt;-</span> <span class="va">erros</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_lgl</a></span><span class="op">(</span><span class="op">~</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">valores</span><span class="op">[</span><span class="va">erro_nao_vazio</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## List of 4
##  $ : chr "9.1"
##  $ : chr "4.4"
##  $ : chr "5.1"
##  $ : chr "7.4"</code></pre>
<p></p>
<p>Repare acima, que antes de aplicar o teste lógico para saber quais erros estavam vazios, eu precisei extrair primeiro o elemento <code>error</code> de todos os elementos de <code>logaritmos</code>. Como uma alternativa, podemos reorganizar os elementos de <code>logaritmos</code> em duas listas diferentes, uma contendo todos os resultados gerados (<code>result</code>), e outra, contendo todos os erros gerados (<code>error</code>).</p>
<p>Para isso, basta aplicarmos a função <code><a href="https://purrr.tidyverse.org/reference/transpose.html">transpose()</a></code> sobre o objeto <code>logaritmos</code>. Agora, o objeto <code>logaritmos</code> contém dentro dele, uma lista de resultados (<code>result</code>) e uma lista de erros (<code>error</code>).</p>
<p></p>
<div class="sourceCode" id="cb1705"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">logaritmos</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/transpose.html">transpose</a></span><span class="op">(</span><span class="va">logaritmos</span><span class="op">)</span></span>
<span><span class="va">logaritmos</span><span class="op">$</span><span class="va">result</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span></span></code></pre></div>
<pre><code>## [[1]]
## [1] 0.9162907
## 
## [[2]]
## [1] 1.629241
## 
## [[3]]
## [1] 1.902108</code></pre>
<div class="sourceCode" id="cb1707"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">logaritmos</span><span class="op">$</span><span class="va">error</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span></span></code></pre></div>
<pre><code>## [[1]]
## NULL
## 
## [[2]]
## NULL
## 
## [[3]]
## NULL</code></pre>
<p></p>
<p>Com essa estrutura, podemos reproduzir o teste anterior com:</p>
<p></p>
<div class="sourceCode" id="cb1709"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">erro_nao_vazio</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_lgl</a></span><span class="op">(</span><span class="va">logaritmos</span><span class="op">$</span><span class="va">error</span>, <span class="op">~</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">valores</span><span class="op">[</span><span class="va">erro_nao_vazio</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## List of 4
##  $ : chr "9.1"
##  $ : chr "4.4"
##  $ : chr "5.1"
##  $ : chr "7.4"</code></pre>
<p></p>
<p>Portanto, sabemos agora que os elementos <code>"9.1"</code>, <code>"4.4"</code>, <code>"5.1"</code> e <code>"7.4"</code> do objeto <code>valores</code> estão levantando erros quando aplicamos a função <code><a href="https://rdrr.io/r/base/Log.html">log()</a></code> sobre eles. Com isso, podemos reproduzir o erro ao aplicar a função <code><a href="https://rdrr.io/r/base/Log.html">log()</a></code> sobre um desses elementos. Dessa forma, podemos analisar caso a caso de forma mais concentrada, e entender o que está gerando o erro.</p>
<p></p>
<div class="sourceCode" id="cb1711"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="st">"9.1"</span><span class="op">)</span></span></code></pre></div>
<p></p>
<pre><code>Error in log("9.1") : non-numeric argument to mathematical function</code></pre>
<p>De qualquer forma, você provavelmente já entendeu qual é o problema. Esses elementos estão sendo interpretados pelo tipo <code>character</code>, ao invés de um tipo numérico como o tipo <code>double</code>. Em outras palavras, a função <code><a href="https://rdrr.io/r/base/Log.html">log()</a></code> não sabe como calcular o logaritmo de um valor textual (ou uma <em>string</em>), como <code>"9.1"</code>.</p>
<p>Tendo isso em mente, poderíamos aplicar a função <code><a href="https://rdrr.io/r/base/double.html">as.double()</a></code> sobre esses elementos para resolvermos esse problema. Perceba que após realizarmos essa correção, o comando com <code><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl()</a></code> executa normalmente sem nenhum erro.</p>
<p></p>
<div class="sourceCode" id="cb1713"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">valores</span><span class="op">[</span><span class="va">erro_nao_vazio</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">valores</span><span class="op">[</span><span class="va">erro_nao_vazio</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">as.double</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Agora, os comandos abaixo funcionam normalmente</span></span>
<span><span class="co">### sem nenhum erro.</span></span>
<span><span class="va">logaritmos</span> <span class="op">&lt;-</span> <span class="va">valores</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl</a></span><span class="op">(</span><span class="va">log</span><span class="op">)</span></span>
<span><span class="va">logaritmos</span> </span></code></pre></div>
<pre><code>##  [1]  0.9162907  1.6292405  1.9021075  2.1860513  2.2082744 -1.6094379
##  [7]  1.4816045  1.6292405  2.0014800  1.2809338  1.3350011  1.4350845
## [13]  2.1633230  2.1747517</code></pre>
<p></p>
<p>Portanto, a função <code><a href="https://purrr.tidyverse.org/reference/safely.html">safely()</a></code> te oferece um conjunto de informações mais completas sobre cada execução, pois ela te traz exatamente qual foi a mensagem de erro retornada. Porém, em algumas ocasiões, você só quer coletar os resultados gerados.</p>
<p>Para isso, temos uma outra função irmã mais simplificada, que é a função <code><a href="https://purrr.tidyverse.org/reference/safely.html">possibly()</a></code>. Assim como ocorre com <code><a href="https://purrr.tidyverse.org/reference/safely.html">safely()</a></code>, essa função <code><a href="https://purrr.tidyverse.org/reference/safely.html">possibly()</a></code> recebe uma outra função como <em>input</em>, e retorna como <em>output</em>, uma nova versão da função de <em>input</em>. Assim como ocorre com <code><a href="https://purrr.tidyverse.org/reference/safely.html">safely()</a></code>, a função criada por <code><a href="https://purrr.tidyverse.org/reference/safely.html">possibly()</a></code> vai sempre executar com sucesso, mesmo que um erro seja levantado pela função principal <code>.f</code>.</p>
<p>Para mais, a função <code><a href="https://purrr.tidyverse.org/reference/safely.html">possibly()</a></code> te permite definir um valor padrão de retorno, caso a execução da função principal <code>.f</code> retorne um erro. Por exemplo, com os comandos abaixo, estou definindo que se a função <code><a href="https://rdrr.io/r/base/Log.html">log()</a></code> levantar algum erro para um determinado <em>input</em>, ela deve retornar como <em>output</em> o valor <code>NA_real_</code>.</p>
<p></p>
<div class="sourceCode" id="cb1715"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">valores</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>  <span class="fl">3.2</span>, <span class="fl">4.4</span>, <span class="fl">5.1</span>, <span class="fl">8.6</span>,</span>
<span>  <span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">valores</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl</a></span><span class="op">(</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/safely.html">possibly</a></span><span class="op">(</span><span class="va">log</span>, <span class="cn">NA_real_</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 1.163151 1.481605 1.629241 2.151762       NA       NA       NA</code></pre>
<p></p>
<p>Apesar de duas opções bastante úteis, você pode ainda estar interessado em coletar outras informações sobre a execução de cada iteração. Como exemplo, a função <code><a href="https://purrr.tidyverse.org/reference/safely.html">quietly()</a></code> exerce um papel semelhante à <code><a href="https://purrr.tidyverse.org/reference/safely.html">safely()</a></code>, mas, ao invés de coletar erros, essa função busca coletar os resultados, mensagens e avisos gerados em cada iteração, além dos possíveis <em>outputs</em> que são mostrados na tela.</p>
<p>Perceba no exemplo abaixo, que assim como ocorre com <code><a href="https://purrr.tidyverse.org/reference/safely.html">safely()</a></code> e <code><a href="https://purrr.tidyverse.org/reference/safely.html">possibly()</a></code>, <code><a href="https://purrr.tidyverse.org/reference/safely.html">quietly()</a></code> também nos retorna uma nova versão da função <code><a href="https://rdrr.io/r/base/print.html">print()</a></code>. Quando eu aplico essa nova função sobre algum <em>input</em> qualquer, é retornado uma lista com 4 elementos. Como os elementos <code>warnings</code> e <code>messages</code> abaixo estão vazios, isso significa que não houveram avisos ou mensagens acionadas durante a execução da expressão <code>print(8)</code>. Para mais, podemos ver através dos itens <code>result</code> e <code>output</code>, o resultado da expressão e, também, qual é o texto apresentado em nosso console quando a expressão <code>print(8)</code> é executada.</p>
<p></p>
<div class="sourceCode" id="cb1717"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">quiet_print</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/safely.html">quietly</a></span><span class="op">(</span><span class="va">print</span><span class="op">)</span></span>
<span><span class="fu">quiet_print</span><span class="op">(</span><span class="fl">8</span><span class="op">)</span></span></code></pre></div>
<pre><code>## $result
## [1] 8
## 
## $output
## [1] "[1] 8"
## 
## $warnings
## character(0)
## 
## $messages
## character(0)</code></pre>
<p></p>
<p>Sendo assim, podemos utilizar a função <code><a href="https://purrr.tidyverse.org/reference/safely.html">quietly()</a></code> em conjunto com <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> para coletarmos essas informações sobre a execução de uma função qualquer sobre vários <em>inputs</em> diferentes. Veja no exemplo abaixo, que o segundo <em>input</em> da lista <code>x</code> (<code>-10</code>) gerou um aviso, pois o elemento <code>warnings</code> da segunda lista no resultado não está vazio.</p>
<p></p>
<div class="sourceCode" id="cb1719"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fl">5</span>, <span class="op">-</span><span class="fl">10</span>, <span class="fl">15</span><span class="op">)</span></span>
<span><span class="va">x</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/safely.html">quietly</a></span><span class="op">(</span><span class="va">log</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## List of 3
##  $ :List of 4
##   ..$ result  : num 1.61
##   ..$ output  : chr ""
##   ..$ warnings: chr(0) 
##   ..$ messages: chr(0) 
##  $ :List of 4
##   ..$ result  : num NaN
##   ..$ output  : chr ""
##   ..$ warnings: chr "NaNs produzidos"
##   ..$ messages: chr(0) 
##  $ :List of 4
##   ..$ result  : num 2.71
##   ..$ output  : chr ""
##   ..$ warnings: chr(0) 
##   ..$ messages: chr(0)</code></pre>
<p></p>
</div>
<div id="compreendendo-as-funções-map_dfr-e-map_dfc" class="section level2" number="16.6">
<h2>
<span class="header-section-number">16.6</span> Compreendendo as funções <code>map_dfr()</code> e <code>map_dfc()</code><a class="anchor" aria-label="anchor" href="#compreendendo-as-fun%C3%A7%C3%B5es-map_dfr-e-map_dfc"><i class="fas fa-link"></i></a>
</h2>
<p>Novamente, as funções <code><a href="https://purrr.tidyverse.org/reference/map.html">map_dfc()</a></code> e <code><a href="https://purrr.tidyverse.org/reference/map.html">map_dfr()</a></code> realizam exatamente o mesmo trabalho e possuem os mesmos argumentos das demais funções <code>map</code>. Contudo, como você já deve ter pressuposto pelo sufixo <code>df</code>, as funções <code><a href="https://purrr.tidyverse.org/reference/map.html">map_dfc()</a></code> e <code><a href="https://purrr.tidyverse.org/reference/map.html">map_dfr()</a></code> retornam como resultado, um <code>data.frame</code>. Porém, essas duas funções constroem esse novo <code>data.frame</code> de maneiras distintas.</p>
<p>Em primeiro lugar, você pode utilizar as funções <code><a href="https://purrr.tidyverse.org/reference/map.html">map_dfr()</a></code> e <code><a href="https://purrr.tidyverse.org/reference/map.html">map_dfc()</a></code>, sempre que um <code>data.frame</code> é gerado a cada iteração do <em>loop</em> criado pela função <code>map</code>. Ou seja, quando aplicamos a função <code>.f</code> sobre um elemento de <code>.x</code>, um <code>data.frame</code> é gerado como resultado. Dito ainda de uma outra forma, a função <code>.f</code> recebe um elemento de <code>.x</code> como <em>input</em>, e gera um novo <code>data.frame</code> como <em>output</em>.</p>
<p></p>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:unnamed-chunk-913"></span>
<img src="Figuras/map_dfr.png" alt="\texttt{map\_dfr()} une os `data.frame`'s gerados, por linha" width="80%"><p class="caption">
Figura 16.5:  une os <code>data.frame</code>’s gerados, por linha
</p>
</div>
<p></p>
<p></p>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:unnamed-chunk-914"></span>
<img src="Figuras/map_dfc.png" alt="\texttt{map\_dfc()} une os `data.frame`'s gerados, por coluna" width="100%"><p class="caption">
Figura 16.6:  une os <code>data.frame</code>’s gerados, por coluna
</p>
</div>
<p></p>
<p>Portanto, se você utiliza a função <code>map_df*()</code> sobre um objeto de 50 elementos, é esperado que 50 <code>data.frame</code>’s sejam gerados durante a execução de <code>map_df*()</code>. Após gerar todos esses 50 <code>data.frame</code>’s, a função <code>map_df*()</code> em questão, vai tentar uni-los em um único <code>data.frame</code>. Por fim, a função vai retornar como resultado, esse <code>data.frame</code> único, que contém os resultados de todos os 50 <code>data.frame</code>’s gerados.</p>
<p>Por isso, a única diferença essencial entre as funções <code><a href="https://purrr.tidyverse.org/reference/map.html">map_dfr()</a></code> e <code><a href="https://purrr.tidyverse.org/reference/map.html">map_dfc()</a></code>, está na forma como essas funções vão unir esses 50 <code>data.frame</code>’s gerados. Como você pode observar nas figuras 16.5 e 16.6, <code><a href="https://purrr.tidyverse.org/reference/map.html">map_dfr()</a></code> une os <code>data.frame</code>’s por linha, enquanto <code><a href="https://purrr.tidyverse.org/reference/map.html">map_dfc()</a></code>, une por coluna.</p>
<p>Tendo esses pontos em mente, as funções <code><a href="https://purrr.tidyverse.org/reference/map.html">map_dfr()</a></code> e <code><a href="https://purrr.tidyverse.org/reference/map.html">map_dfc()</a></code> são particularmente úteis, quando desejamos aplicar uma função sobre cada elemento de um objeto, e armazenar todos os resultados em um <code>data.frame</code> único.</p>
</div>
<div id="sec:demanda_dist_ICMS" class="section level2" number="16.7">
<h2>
<span class="header-section-number">16.7</span> Um estudo de caso: uma demanda real sobre a distribuição de ICMS<a class="anchor" aria-label="anchor" href="#sec:demanda_dist_ICMS"><i class="fas fa-link"></i></a>
</h2>
<p>Nessa seção, vou apresentar um exemplo prático, sobre uma demanda real que chegou até mim em 2020. Na época, eu trabalhava como estagiário na Diretoria de Estatística e Informações da Fundação João Pinheiro (FJP-MG), mais especificamente com uma lei estadual que é tradicionalmente chamada de Lei Robin Hood (Lei 18.030 de 2009 - MG). Essa lei rege a distribuição do ICMS total de Minas Gerais, ao longo dos municípios do estado.</p>
<p>Em resumo, o Governo de Minas Gerais, coleta o ICMS (imposto sobre operações relativas à circulação de mercadorias e sobre prestações de serviços de transporte interestadual, intermunicipal e de comunicação) gerado em todo o estado, e ao final de um período, ele redistribui esse valor para os 853 municípios do estado. Cada município, possui um índice de participação, que corresponde à porcentagem do ICMS total ao qual o respectivo município tem direito. Em outras palavras, se o ICMS total gerado no estado em um período foi de 8,5 bilhões de reais, e o município de Belo Horizonte possui um índice de participação equivalente a 0,009, isso significa que ao final do período, 0,9% do ICMS total, ou 76,5 milhões de reais serão transferidos para a prefeitura do município de Belo Horizonte.</p>
<p>Diversos critérios descritos na lei regem o cálculo deste índice de participação de cada município, sendo alguns deles: Turismo, Esporte, Patrimônio Cultural, População e Receita Própria. Em suma, o índice de participação de cada município, é uma média ponderada dos índices de cada um desses diversos critérios da lei. Você pode encontrar uma descrição completa desses critérios e do cálculo dos índices de participação, no texto original da lei<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="https://www.almg.gov.br/consulte/legislacao/completa/completa-nova-min.html?tipo=LEI&amp;amp;num=18030&amp;amp;comp=&amp;amp;ano=2009&amp;amp;texto=original" class="uri"&gt;https://www.almg.gov.br/consulte/legislacao/completa/completa-nova-min.html?tipo=LEI&amp;amp;num=18030&amp;amp;comp=&amp;amp;ano=2009&amp;amp;texto=original&lt;/a&gt;&lt;/p&gt;'><sup>66</sup></a>.</p>
<div id="a-demanda-em-si" class="section level3" number="16.7.1">
<h3>
<span class="header-section-number">16.7.1</span> A demanda em si<a class="anchor" aria-label="anchor" href="#a-demanda-em-si"><i class="fas fa-link"></i></a>
</h3>
<p>A demanda é muito simples, porém, ela é trabalhosa e envolve um volume excessivo de repetição se você optar por utilizar programas como Excel para resolvê-la. Dentre os vários critérios da lei, temos o critério de Meio Ambiente, e o órgão responsável pelo cálculo do índice referente a esse critério, é a SEMAD-MG (Secretaria de Estado de Meio Ambiente e Desenvolvimento Sustentável). Um dia, a SEMAD chegou até nós da Fundação João Pinheiro (FJP), pedindo por todos os valores de ICMS transferidos para cada município, ao longo dos anos de 2018 e 2019, de acordo com o critério do Meio Ambiente da Lei Robin Hood.</p>
<p>Os funcionários da FJP, calculam e publicam todo mês, os valores transferidos de ICMS separados por cada critério da lei, e para cada município. Ou seja, para o ano de 2019, pense por exemplo, em uma lista de arquivos de Excel parecida com a lista abaixo, onde cada planilha corresponde aos valores de ICMS transferidos em um mês específico do ano.</p>
<p></p>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:unnamed-chunk-915"></span>
<img src="Figuras/planilhas1.png" alt="Lista de arquivos do Excel" width="80%"><p class="caption">
Figura 16.7: Lista de arquivos do Excel
</p>
</div>
<p></p>
<p>Dando uma olhada mais de perto, cada uma dessas planilhas do Excel, assumem a estrutura abaixo. Onde cada linha da tabela, representa um município do estado de Minas Gerais, e cada coluna (ou pelo menos, grande parte dessas colunas), representa os valores de ICMS transferidos segundo os índices de um critério específico da lei. Ou seja, a coluna <code>Educação</code>, nos apresenta os valores de ICMS transferidos para cada município do estado, considerando-se o índice que cada um desses municípios adquiriram no critério de Educação, e também, considerando-se a parcela que o critério de Educação representa do total de ICMS distribuído.</p>
<p></p>
<div class="sourceCode" id="cb1721"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://readxl.tidyverse.org">readxl</a></span><span class="op">)</span></span>
<span><span class="va">Abril_2019</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html">read_excel</a></span><span class="op">(</span><span class="st">"planilhas/Abril_2019.xlsx"</span><span class="op">)</span></span>
<span><span class="va">Abril_2019</span></span></code></pre></div>
<pre><code>## # A tibble: 853 × 27
##     IBGE1 IBGE2   SEF Municípios    Popul…¹ Popul…² Área …³ Educa…⁴ Patri…⁵
##     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;           &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;
##  1 310010    10     1 ABADIA DOS D…   8847.       0  14884.      0    5309.
##  2 310020    20     2 ABAETÉ         29470.       0  30581.  29902.   7588.
##  3 310030    30     3 ABRE CAMPO     17087.       0   7927.      0   12200.
##  4 310040    40     4 ACAIACA         5068.       0   1724.  26722.  14681.
##  5 310050    50     5 AÇUCENA        12151.       0  13678.  29271.      0 
##  6 310060    60     6 ÁGUA BOA       17258.       0  22285.      0   14225.
##  7 310070    70     7 ÁGUA COMPRIDA   2544.       0   8301.      0    7402.
##  8 310080    80     8 AGUANIL         5644.       0   3920.  27662.      0 
##  9 310090    90     9 ÁGUAS FORMOS…  24321.       0  13784.      0   11780.
## 10 310100   100    10 ÁGUAS VERMEL…  17102.       0  21202.  33664.   5657.
## # … with 843 more rows, 18 more variables: `Receita Própria` &lt;dbl&gt;,
## #   `Cota Mínima` &lt;dbl&gt;, Mineradores &lt;dbl&gt;, `Saúde Per Capita` &lt;dbl&gt;,
## #   VAF &lt;dbl&gt;, Esportes &lt;dbl&gt;, Turismo &lt;dbl&gt;, Penitenciárias &lt;dbl&gt;,
## #   `Recursos Hídricos` &lt;dbl&gt;, `Produção de Alimentos 2º semestre` &lt;dbl&gt;,
## #   `Unidades de Conservação (IC i)` &lt;dbl&gt;, Saneamento &lt;dbl&gt;,
## #   `Mata Seca` &lt;dbl&gt;, `Meio Ambiente` &lt;dbl&gt;, PSF &lt;dbl&gt;,
## #   `ICMS Solidário` &lt;dbl&gt;, `Índice Mínimo per capita` &lt;dbl&gt;, …</code></pre>
<p></p>
<p>Porém, temos dois problemas aqui: 1) A SEMAD precisa apenas dos valores de ICMS transferidos de acordo com o critério de Meio Ambiente, e nada mais; 2) A SEMAD precisa dos valores de ICMS transferidos ao longo de todos os meses dos anos de 2018 e 2019, e se nós temos 12 planilhas por ano, temos que reunir informações de 24 planilhas diferentes para a secretaria.</p>
<p>Portanto, temos aqui uma típica tarefa extremamente repetitiva e monótona, que ninguém gosta de fazer. Imagine você abrindo na mão, cada uma das 24 planilhas, procurando pela coluna do Meio Ambiente, copiando e colando ela em um novo arquivo contendo apenas os dados de Meio Ambiente, preenchendo colunas de ano e mês para manter a rastreabilidade dos registros, etc. Aqueles com mais experiência no Excel, poderiam argumentar que uma solução mais segura, seria utilizar a plataforma de <em>queries</em> do programa para carregar os dados das 24 planilhas em uma planilha única. Porém, apenas pelo tempo que você levaria para importar cada arquivo e configurar cada <em>querie</em>, seria muito mais rápido se você simplesmente adotasse a estratégia de <code>Crtl+C</code> e <code>Ctrl+V</code>, para transferir todos os dados para uma planilha única.</p>
<p>Além disso, tarefas muito repetitivas são, não apenas muito cansativas, mas também, muito <em>error-prone</em> (ou seja, elas elevam muito as suas chances de erros). Esses são dois fatores que podem ser facilmente evitados através do uso de funções e de <em>loop</em>’s no R. Ao construir uma função que define as ações que você deseja aplicar, e um <em>loop</em> que replique essa função para todas as x planilhas, você permite que o seu computador realize o trabalho duro e cansativo por você. Com isso, as suas chances de erro se reduzem muito, e você realiza o mesmo trabalho em menor tempo. Pois os nossos computadores são extremamente rápidos e precisos para realizar todo tipo de cálculo. Afinal, é para isso que eles foram feitos.</p>
</div>
<div id="planejando-os-passos" class="section level3" number="16.7.2">
<h3>
<span class="header-section-number">16.7.2</span> Planejando os passos<a class="anchor" aria-label="anchor" href="#planejando-os-passos"><i class="fas fa-link"></i></a>
</h3>
<p>Como exemplo prático, para formatar os arquivos segundo as necessidades da SEMAD-MG, vou demonstrar as seguintes etapas: 1) importar essas planilhas para o R; 2) adicionar colunas de referência para cada planilha (ano e mês a que os dados se referem); 3) unir todas as planilhas em uma tabela única; 4) selecionar apenas as colunas relevantes para a SEMAD; 5) exportar o resultado para fora do R.</p>
</div>
<div id="importando-as-planilhas" class="section level3" number="16.7.3">
<h3>
<span class="header-section-number">16.7.3</span> Importando as planilhas<a class="anchor" aria-label="anchor" href="#importando-as-planilhas"><i class="fas fa-link"></i></a>
</h3>
<p>Tendo isso em mente, o primeiro passo seria importarmos essas planilhas. Mas, para isso precisamos dos <em>path</em>’s, ou, dos caminhos até esses arquivos. Podemos coletar essa informação, através da função <code><a href="https://rdrr.io/r/base/list.files.html">list.files()</a></code>, a qual pertence aos pacotes básicos do R. Como o próprio nome dá a entender, essa função busca listar os nomes de todos os arquivos contidos em determinada uma pasta. Caso você não defina alguma pasta específica na função (diferente do que fizemos abaixo), <code><a href="https://rdrr.io/r/base/list.files.html">list.files()</a></code> vai listar todos os arquivos presentes no seu diretório de trabalho atual do R.</p>
<p>Neste exemplo, todas as 12 planilhas já estão separadas dentro de uma pasta de meu computador chamada <code>"planilhas"</code>. Por isso, forneço abaixo o nome dessa pasta à função <code><a href="https://rdrr.io/r/base/list.files.html">list.files()</a></code>. Como resultado, o objeto <code>caminhos</code> contém o caminho até todas essas planilhas que desejamos importar para dentro do R.</p>
<p></p>
<div class="sourceCode" id="cb1723"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">caminhos</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="st">"planilhas/"</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">caminhos</span></span></code></pre></div>
<pre><code>##  [1] "planilhas//Abril_2019.xlsx"     "planilhas//Agosto_2019.xlsx"   
##  [3] "planilhas//Dezembro_2019.xlsx"  "planilhas//Fevereiro_2019.xlsx"
##  [5] "planilhas//Janeiro_2019.xlsx"   "planilhas//Julho_2019.xlsx"    
##  [7] "planilhas//Junho_2019.xlsx"     "planilhas//Maio_2019.xlsx"     
##  [9] "planilhas//Marco_2019.xlsx"     "planilhas//Novembro_2019.xlsx" 
## [11] "planilhas//Outubro_2019.xlsx"   "planilhas//Setembro_2019.xlsx"</code></pre>
<p></p>
<p>Agora que temos os caminhos até todas essas planilhas, importá-las para dentro do R se torna algo extremamente simples. Podemos simplesmente utilizar a função <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> para aplicar uma função (que seja capaz de ler esses arquivos) sobre cada um desses caminhos. Lembre-se que, podemos importar planilhas do Excel para dentro do R, através da função <code><a href="https://readxl.tidyverse.org/reference/read_excel.html">readxl::read_excel()</a></code> que introduzimos no capítulo 4.</p>
<p></p>
<div class="sourceCode" id="cb1725"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://readxl.tidyverse.org">readxl</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://purrr.tidyverse.org/">purrr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">planilhas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">caminhos</span>, <span class="va">read_excel</span><span class="op">)</span></span>
<span><span class="va">planilhas</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<pre><code>## # A tibble: 853 × 27
##     IBGE1 IBGE2   SEF Municípios    Popul…¹ Popul…² Área …³ Educa…⁴ Patri…⁵
##     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;           &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;
##  1 310010    10     1 ABADIA DOS D…   8847.       0  14884.      0    5309.
##  2 310020    20     2 ABAETÉ         29470.       0  30581.  29902.   7588.
##  3 310030    30     3 ABRE CAMPO     17087.       0   7927.      0   12200.
##  4 310040    40     4 ACAIACA         5068.       0   1724.  26722.  14681.
##  5 310050    50     5 AÇUCENA        12151.       0  13678.  29271.      0 
##  6 310060    60     6 ÁGUA BOA       17258.       0  22285.      0   14225.
##  7 310070    70     7 ÁGUA COMPRIDA   2544.       0   8301.      0    7402.
##  8 310080    80     8 AGUANIL         5644.       0   3920.  27662.      0 
##  9 310090    90     9 ÁGUAS FORMOS…  24321.       0  13784.      0   11780.
## 10 310100   100    10 ÁGUAS VERMEL…  17102.       0  21202.  33664.   5657.
## # … with 843 more rows, 18 more variables: `Receita Própria` &lt;dbl&gt;,
## #   `Cota Mínima` &lt;dbl&gt;, Mineradores &lt;dbl&gt;, `Saúde Per Capita` &lt;dbl&gt;,
## #   VAF &lt;dbl&gt;, Esportes &lt;dbl&gt;, Turismo &lt;dbl&gt;, Penitenciárias &lt;dbl&gt;,
## #   `Recursos Hídricos` &lt;dbl&gt;, `Produção de Alimentos 2º semestre` &lt;dbl&gt;,
## #   `Unidades de Conservação (IC i)` &lt;dbl&gt;, Saneamento &lt;dbl&gt;,
## #   `Mata Seca` &lt;dbl&gt;, `Meio Ambiente` &lt;dbl&gt;, PSF &lt;dbl&gt;,
## #   `ICMS Solidário` &lt;dbl&gt;, `Índice Mínimo per capita` &lt;dbl&gt;, …</code></pre>
<p></p>
<p>Agora, o objeto <code>planilhas</code> é uma lista de 12 elementos. Cada elemento dessa lista, contém um <code>data.frame</code> que corresponde aos dados de uma das 12 planilhas.</p>
</div>
<div id="conferindo-a-estrutura-dos-arquivos" class="section level3" number="16.7.4">
<h3>
<span class="header-section-number">16.7.4</span> Conferindo a estrutura dos arquivos<a class="anchor" aria-label="anchor" href="#conferindo-a-estrutura-dos-arquivos"><i class="fas fa-link"></i></a>
</h3>
<p>Vamos aproveitar que já importamos as 12 planilhas, para fazermos algumas conferências sobre esses arquivos. Será que todas as planilhas possuem a mesma estrutura (o mesmo número de linhas, as mesmas colunas, os mesmos tipos de dados, etc.) ? Logo abaixo, estamos utilizando a função <code><a href="https://rdrr.io/r/base/nrow.html">nrow()</a></code> para coletarmos os números de linhas de cada tabela, <code><a href="https://rdrr.io/r/base/nrow.html">ncol()</a></code> para o número de colunas, e <code><a href="https://rdrr.io/r/base/colnames.html">colnames()</a></code> para os nomes das colunas. Perceba abaixo, que todas as planilhas possuem o mesmo número de linhas e colunas.</p>
<p></p>
<div class="sourceCode" id="cb1727"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n_linhas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_int</a></span><span class="op">(</span><span class="va">planilhas</span>, <span class="va">nrow</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">n_linhas</span><span class="op">)</span></span></code></pre></div>
<pre><code>##  [1] 853 853 853 853 853 853 853 853 853 853 853 853</code></pre>
<div class="sourceCode" id="cb1729"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n_colunas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_int</a></span><span class="op">(</span><span class="va">planilhas</span>, <span class="va">ncol</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">n_colunas</span><span class="op">)</span></span></code></pre></div>
<pre><code>##  [1] 27 27 27 27 27 27 27 27 27 27 27 27</code></pre>
<p></p>
<p>Para conferirmos os nomes das colunas temos um pouco mais de trabalho, mas nada que seja muito distante do que foi mostrado até o momento.</p>
<p></p>
<div class="sourceCode" id="cb1731"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nomes_colunas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">planilhas</span>, <span class="va">colnames</span><span class="op">)</span></span>
<span><span class="va">referencia</span> <span class="op">&lt;-</span> <span class="va">nomes_colunas</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="va">igual_a_referencia</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span><span class="st">"logical"</span>, length <span class="op">=</span> <span class="fl">12</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">nomes_colunas</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">igual_a_referencia</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/all.html">all</a></span><span class="op">(</span><span class="va">nomes_colunas</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">==</span> <span class="va">referencia</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">igual_a_referencia</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">caminhos</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">igual_a_referencia</span><span class="op">)</span></span></code></pre></div>
<pre><code>##     planilhas//Abril_2019.xlsx    planilhas//Agosto_2019.xlsx 
##                           TRUE                           TRUE 
##  planilhas//Dezembro_2019.xlsx planilhas//Fevereiro_2019.xlsx 
##                          FALSE                           TRUE 
##   planilhas//Janeiro_2019.xlsx     planilhas//Julho_2019.xlsx 
##                           TRUE                           TRUE 
##     planilhas//Junho_2019.xlsx      planilhas//Maio_2019.xlsx 
##                           TRUE                           TRUE 
##     planilhas//Marco_2019.xlsx  planilhas//Novembro_2019.xlsx 
##                           TRUE                          FALSE 
##   planilhas//Outubro_2019.xlsx  planilhas//Setembro_2019.xlsx 
##                           TRUE                           TRUE</code></pre>
<p></p>
<p>Perceba pelo resultado acima, que os arquivos <code>Dezembro_2019.xlsx</code> e <code>Novembro_2019.xlsx</code> possuem alguma divergência no nome de suas colunas. Podemos rapidamente descobrir que colunas são essas com um simples teste lógico e <em>subsetting</em>:</p>
<p></p>
<div class="sourceCode" id="cb1733"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Coluna diferente no arquivo Dezembro_2019.xlsx</span></span>
<span><span class="va">nomes_colunas</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">[</span> <span class="op">!</span><span class="va">referencia</span> <span class="op">==</span> <span class="va">nomes_colunas</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span> <span class="op">]</span></span></code></pre></div>
<pre><code>## [1] "cota minima"</code></pre>
<div class="sourceCode" id="cb1735"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Coluna diferente no arquivo Novembro_2019.xlsx</span></span>
<span><span class="va">nomes_colunas</span><span class="op">[[</span><span class="fl">10</span><span class="op">]</span><span class="op">]</span><span class="op">[</span> <span class="op">!</span><span class="va">referencia</span> <span class="op">==</span> <span class="va">nomes_colunas</span><span class="op">[[</span><span class="fl">10</span><span class="op">]</span><span class="op">]</span> <span class="op">]</span></span></code></pre></div>
<pre><code>## [1] "cota minima"</code></pre>
<p></p>
<p>Pelos resultados acima, podemos observar que as duas planilhas possuem uma coluna chamada <code>cota minima</code>, a qual não está presente nas demais planilhas. Essa mesma coluna está nomeada como <code>Cota Mínima</code>, nas demais planilhas. Como resultado, caso você estivesse aplicando um <em>loop</em> sobre cada uma das 12 planilhas, e estivesse procurando por uma coluna chamada <code>Cota Mínima</code> em cada uma delas, o R não seria capaz de encontrar essa coluna nos arquivos <code>Dezembro_2019.xlsx</code> e <code>Novembro_2019.xlsx</code>.</p>
<p>Pelo fato de estarmos preocupados com a coluna de <code>Meio Ambiente</code>, essa diferença se torna um pouco irrelevante para nós. Entretanto, caso estivéssemos trabalhando com essa coluna de <code>Cota Mínima</code> em cada planilha, teríamos um grande problema a ser resolvido.</p>
</div>
<div id="adicionando-colunas-de-referência" class="section level3" number="16.7.5">
<h3>
<span class="header-section-number">16.7.5</span> Adicionando colunas de referência<a class="anchor" aria-label="anchor" href="#adicionando-colunas-de-refer%C3%AAncia"><i class="fas fa-link"></i></a>
</h3>
<p>Apesar de já termos importado todas as 12 planilhas, temos um grande problema a ser solucionado. Os dados de cada planilha não possuem qualquer coluna ou metadado de referência que indique o período ao qual os dados se referem.</p>
<p>Dito de outra forma, ao olharmos para os dados da primeira planilha, podemos ver os valores monetários de cada município para cada critério. Porém, a que mês esses valores monetários se referem? Dezembro? Janeiro? Março? E de que ano? 2019? ou 2020?</p>
<p></p>
<div class="sourceCode" id="cb1737"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">planilhas</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<pre><code>## # A tibble: 853 × 27
##     IBGE1 IBGE2   SEF Municípios    Popul…¹ Popul…² Área …³ Educa…⁴ Patri…⁵
##     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;           &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;
##  1 310010    10     1 ABADIA DOS D…   8847.       0  14884.      0    5309.
##  2 310020    20     2 ABAETÉ         29470.       0  30581.  29902.   7588.
##  3 310030    30     3 ABRE CAMPO     17087.       0   7927.      0   12200.
##  4 310040    40     4 ACAIACA         5068.       0   1724.  26722.  14681.
##  5 310050    50     5 AÇUCENA        12151.       0  13678.  29271.      0 
##  6 310060    60     6 ÁGUA BOA       17258.       0  22285.      0   14225.
##  7 310070    70     7 ÁGUA COMPRIDA   2544.       0   8301.      0    7402.
##  8 310080    80     8 AGUANIL         5644.       0   3920.  27662.      0 
##  9 310090    90     9 ÁGUAS FORMOS…  24321.       0  13784.      0   11780.
## 10 310100   100    10 ÁGUAS VERMEL…  17102.       0  21202.  33664.   5657.
## # … with 843 more rows, 18 more variables: `Receita Própria` &lt;dbl&gt;,
## #   `Cota Mínima` &lt;dbl&gt;, Mineradores &lt;dbl&gt;, `Saúde Per Capita` &lt;dbl&gt;,
## #   VAF &lt;dbl&gt;, Esportes &lt;dbl&gt;, Turismo &lt;dbl&gt;, Penitenciárias &lt;dbl&gt;,
## #   `Recursos Hídricos` &lt;dbl&gt;, `Produção de Alimentos 2º semestre` &lt;dbl&gt;,
## #   `Unidades de Conservação (IC i)` &lt;dbl&gt;, Saneamento &lt;dbl&gt;,
## #   `Mata Seca` &lt;dbl&gt;, `Meio Ambiente` &lt;dbl&gt;, PSF &lt;dbl&gt;,
## #   `ICMS Solidário` &lt;dbl&gt;, `Índice Mínimo per capita` &lt;dbl&gt;, …</code></pre>
<p></p>
<p>Sabemos que os dados dessa primeira planilha se referem ao mês de abril de 2019, pois essa informação está incrustada no nome da primeira planilha descrita no objeto <code>caminhos</code>, o qual utilizamos para importar todas as 12 planilhas. Porém, qualquer pessoa que não tenha acesso ao objeto <code>caminhos</code>, não será capaz de identificar tal informação.</p>
<p>Por isso, seria muito importante adicionarmos colunas de mês e ano em cada uma das 12 planilhas. Para isso, podemos aplicar os comandos abaixo. Pelo fato do mês e do ano de cada planilha estarem definidos nos próprios nomes dos arquivos, os primeiros comandos buscam extrair essas informações a partir do objeto <code>caminhos</code>. Depois disso, utilizamos um <code>for</code> <em>loop</em> para adicionar essas informações a cada uma 12 tabelas.</p>
<p></p>
<div class="sourceCode" id="cb1739"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nomes_arquivos</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/basename.html">basename</a></span><span class="op">(</span><span class="va">caminhos</span><span class="op">)</span></span>
<span></span>
<span><span class="va">meses</span> <span class="op">&lt;-</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace</a></span><span class="op">(</span></span>
<span>  <span class="va">nomes_arquivos</span>, <span class="st">"(.*)_(.*)[.]xlsx"</span>, <span class="st">"\\1"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">anos</span> <span class="op">&lt;-</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace</a></span><span class="op">(</span></span>
<span>  <span class="va">nomes_arquivos</span>, <span class="st">"(.*)_(.*)[.]xlsx"</span>, <span class="st">"\\2"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">anos</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">anos</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Um for loop para visitar cada uma das</span></span>
<span><span class="co">### 12 planilhas e adicionar as colunas Ano e Mes:</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">planilhas</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">planilhas</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">planilhas</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>      Ano <span class="op">=</span> <span class="va">anos</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,</span>
<span>      Mes <span class="op">=</span> <span class="va">meses</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">### Os dados de Abril de 2019:</span></span>
<span><span class="va">planilhas</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">Ano</span>, <span class="va">Mes</span><span class="op">)</span></span></code></pre></div>
<pre><code>## # A tibble: 853 × 2
##      Ano Mes  
##    &lt;int&gt; &lt;chr&gt;
##  1  2019 Abril
##  2  2019 Abril
##  3  2019 Abril
##  4  2019 Abril
##  5  2019 Abril
##  6  2019 Abril
##  7  2019 Abril
##  8  2019 Abril
##  9  2019 Abril
## 10  2019 Abril
## # … with 843 more rows</code></pre>
<div class="sourceCode" id="cb1741"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">### Os dados de Dezembro de 2019:</span></span>
<span><span class="va">planilhas</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">Ano</span>, <span class="va">Mes</span><span class="op">)</span></span></code></pre></div>
<pre><code>## # A tibble: 853 × 2
##      Ano Mes     
##    &lt;int&gt; &lt;chr&gt;   
##  1  2019 Dezembro
##  2  2019 Dezembro
##  3  2019 Dezembro
##  4  2019 Dezembro
##  5  2019 Dezembro
##  6  2019 Dezembro
##  7  2019 Dezembro
##  8  2019 Dezembro
##  9  2019 Dezembro
## 10  2019 Dezembro
## # … with 843 more rows</code></pre>
<p></p>
</div>
<div id="selecionando-apenas-as-colunas-relevantes" class="section level3" number="16.7.6">
<h3>
<span class="header-section-number">16.7.6</span> Selecionando apenas as colunas relevantes<a class="anchor" aria-label="anchor" href="#selecionando-apenas-as-colunas-relevantes"><i class="fas fa-link"></i></a>
</h3>
<p>Agora que adicionamos as colunas de referência a cada uma das 12 planilhas, podemos nos preocupar em selecionar apenas as colunas relevantes para a SEMAD de cada planilha. Para isso, podemos simplesmente aplicar a função <code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code> que vimos no capítulo 4, sobre cada planilha.</p>
<p>Aqui, podemos nos aproveitar do argumento especial <code>...</code> da função <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code>. Lembre-se que <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> utiliza esse argumento especial para coletar os argumentos que serão repassados para a função (<code>.f</code>) que estamos aplicando.</p>
<p></p>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:unnamed-chunk-924"></span>
<img src="Figuras/map2.png" alt="Relembrando os argumentos de `map()`" width="90%"><p class="caption">
Figura 16.8: Relembrando os argumentos de <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code>
</p>
</div>
<p></p>
<p>Lembre-se também, que os argumentos repassados serão constantes ao longo de todo o <em>loop</em>. Em outras palavras, esses argumentos serão sempre os mesmos em cada chamada da função <code>.f</code>. Logo, quando você digita um comando como <code>map(x, mean, na.rm = TRUE)</code>, a função <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> vai sempre repassar o argumento <code>na.rm</code> com o valor <code>TRUE</code> em cada chamada à função <code><a href="https://rdrr.io/r/base/mean.html">mean()</a></code>.</p>
<!-- ```{r, echo = FALSE, fig.cap = "Argumentos repassados à `...` são reutilizados em cada chamada à função `.f`", out.width="70%"} -->
<!-- knitr::include_graphics("Figuras/map3.png") -->
<!-- ``` -->
<p>Para compreender como você pode se aproveitar desse argumento, pense em como você aplicaria a função <code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code> sobre apenas 1 das 12 planilhas. Perceba abaixo, que estamos repassando os argumentos <code>Ano</code>, <code>Mes</code>, <code>IBGE1</code>, <code>Municípios</code> e <code>Meio Ambiente</code> à função.</p>
<p></p>
<div class="sourceCode" id="cb1743"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">planilhas</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">Ano</span>, <span class="va">Mes</span>, <span class="va">IBGE1</span>, <span class="va">Municípios</span>, <span class="va">`Meio Ambiente`</span><span class="op">)</span></span></code></pre></div>
<pre><code>## # A tibble: 853 × 5
##      Ano Mes    IBGE1 Municípios          `Meio Ambiente`
##    &lt;int&gt; &lt;chr&gt;  &lt;dbl&gt; &lt;chr&gt;                         &lt;dbl&gt;
##  1  2019 Abril 310010 ABADIA DOS DOURADOS              0 
##  2  2019 Abril 310020 ABAETÉ                           0 
##  3  2019 Abril 310030 ABRE CAMPO                   10433.
##  4  2019 Abril 310040 ACAIACA                          0 
##  5  2019 Abril 310050 AÇUCENA                       7727.
##  6  2019 Abril 310060 ÁGUA BOA                     10433.
##  7  2019 Abril 310070 ÁGUA COMPRIDA                21909.
##  8  2019 Abril 310080 AGUANIL                          0 
##  9  2019 Abril 310090 ÁGUAS FORMOSAS                   0 
## 10  2019 Abril 310100 ÁGUAS VERMELHAS              14750.
## # … with 843 more rows</code></pre>
<p></p>
<p>Essas são as colunas que estamos interessados em extrair de cada planilha. Ou seja, queremos sempre repassar esses 5 argumentos à função <code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code>, pois desejamos selecionar sempre essas mesmas colunas de cada planilha. Tendo isso em mente, podemos aplicar o seguinte comando:</p>
<p></p>
<div class="sourceCode" id="cb1745"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">planilhas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span></span>
<span>  <span class="va">planilhas</span>, <span class="va">select</span>,</span>
<span>  <span class="co">## Argumentos repassados para select():</span></span>
<span>  <span class="va">Ano</span>, <span class="va">Mes</span>, <span class="va">IBGE1</span>, <span class="va">Municípios</span>, <span class="va">`Meio Ambiente`</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p></p>
</div>
<div id="unindo-as-12-planilhas-em-uma-só" class="section level3" number="16.7.7">
<h3>
<span class="header-section-number">16.7.7</span> Unindo as 12 planilhas em uma só<a class="anchor" aria-label="anchor" href="#unindo-as-12-planilhas-em-uma-s%C3%B3"><i class="fas fa-link"></i></a>
</h3>
<p>Temos agora, uma lista contendo todas as 12 planilhas com apenas as colunas que a SEMAD necessita. Porém, lembre-se que cada planilha, está atualmente separada em um elemento diferente da lista. Nós estabelecemos anteriormente, que o ideal seria reunirmos todas essas 12 tabelas, em uma só.</p>
<p>Para executarmos esse passo, nós podemos simplesmente aplicar a função <code><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows()</a></code> (que introduzimos no capítulo 4) sobre a lista <code>planilhas</code>. Se nós temos 12 planilhas diferentes, onde, cada linha de cada planilha representa um dos 853 municípios de Minas Gerais, ao unirmos todas essas tabelas, devemos ter como resultado, uma única tabela contendo 10.236 linhas (<span class="math inline">\(853 \times 12 = 10.236\)</span>).</p>
<p></p>
<div class="sourceCode" id="cb1746"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">resultado</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span><span class="va">planilhas</span><span class="op">)</span></span>
<span><span class="va">resultado</span></span></code></pre></div>
<pre><code>## # A tibble: 10,236 × 5
##      Ano Mes    IBGE1 Municípios          `Meio Ambiente`
##    &lt;int&gt; &lt;chr&gt;  &lt;dbl&gt; &lt;chr&gt;                         &lt;dbl&gt;
##  1  2019 Abril 310010 ABADIA DOS DOURADOS              0 
##  2  2019 Abril 310020 ABAETÉ                           0 
##  3  2019 Abril 310030 ABRE CAMPO                   10433.
##  4  2019 Abril 310040 ACAIACA                          0 
##  5  2019 Abril 310050 AÇUCENA                       7727.
##  6  2019 Abril 310060 ÁGUA BOA                     10433.
##  7  2019 Abril 310070 ÁGUA COMPRIDA                21909.
##  8  2019 Abril 310080 AGUANIL                          0 
##  9  2019 Abril 310090 ÁGUAS FORMOSAS                   0 
## 10  2019 Abril 310100 ÁGUAS VERMELHAS              14750.
## # … with 10,226 more rows</code></pre>
<p></p>
<p>Contudo, se você relembrar da função <code><a href="https://purrr.tidyverse.org/reference/map.html">map_dfr()</a></code> que expomos anteriormente, você pode chegar à conclusão de que poderíamos ter eliminado esse passo, ao utilizarmos essa função <code><a href="https://purrr.tidyverse.org/reference/map.html">map_dfr()</a></code> para aplicarmos a função <code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code> sobre cada planilha. Pois, como destacamos, a função <code><a href="https://purrr.tidyverse.org/reference/map.html">map_dfr()</a></code> vai aplicar a função <code>.f</code> sobre cada elemento de <code>.x</code> e, em seguida, vai tentar unir todos os resultados em um único <code>data.frame</code>.</p>
<p></p>
<div class="sourceCode" id="cb1748"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Todos os resultados já são armazenados</span></span>
<span><span class="co">## em um único data.frame:</span></span>
<span><span class="va">resultado</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dfr</a></span><span class="op">(</span></span>
<span>  <span class="va">planilhas</span>, <span class="va">select</span>,</span>
<span>  <span class="co">## Argumentos repassados para select():</span></span>
<span>  <span class="va">Ano</span>, <span class="va">Mes</span>, <span class="va">IBGE1</span>, <span class="va">Municípios</span>, <span class="va">`Meio Ambiente`</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p></p>
</div>
<div id="conclusão" class="section level3" number="16.7.8">
<h3>
<span class="header-section-number">16.7.8</span> Conclusão<a class="anchor" aria-label="anchor" href="#conclus%C3%A3o"><i class="fas fa-link"></i></a>
</h3>
<p>Portanto, uma tarefa que inicialmente seria trabalhosa e extremamente repetitiva em muitos programas comuns (como o Excel), pode ser resolvida no R de maneira fácil e rápida, através do uso das funções <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code>.</p>
<p>Tínhamos como objetivo, reunir os dados presentes em 12 planilhas em uma única tabela, e em seguida, selecionar apenas aquelas colunas que eram de interesse da SEMAD. Se reunirmos todos os comandos que utilizamos no R, temos um <em>script</em> com mais ou menos 30 linhas. Ou seja, com apenas 30 linhas, somos capazes de economizar um tempo e esforço enormes em nosso trabalho.</p>
<p>A partir daqui, com a tabela única em nossas mãos, nós precisamos apenas exportar essa tabela para fora do R. Algo que pode ser rapidamente realizado através de uma função como a <code><a href="https://readr.tidyverse.org/reference/write_delim.html">write_csv2()</a></code>, que introduzimos na seção <a href="#sec:exportando_readr">Exportando dados em arquivos de texto com readr</a>.</p>
<p></p>
<div class="sourceCode" id="cb1749"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">caminhos</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="st">"planilhas/"</span><span class="op">)</span></span>
<span><span class="va">planilhas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">caminhos</span>, <span class="va">planilhas</span><span class="op">)</span></span>
<span></span>
<span><span class="va">nomes_arquivos</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/basename.html">basename</a></span><span class="op">(</span><span class="va">caminhos</span><span class="op">)</span></span>
<span></span>
<span><span class="va">meses</span> <span class="op">&lt;-</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace</a></span><span class="op">(</span></span>
<span>  <span class="va">nomes_arquivos</span>, <span class="st">"(.*)_(.*)[.]xlsx"</span>, <span class="st">"\\1"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">anos</span> <span class="op">&lt;-</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace</a></span><span class="op">(</span></span>
<span>  <span class="va">nomes_arquivos</span>, <span class="st">"(.*)_(.*)[.]xlsx"</span>, <span class="st">"\\2"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">anos</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">anos</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">planilhas</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">planilhas</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">planilhas</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>      Ano <span class="op">=</span> <span class="va">anos</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,</span>
<span>      Mes <span class="op">=</span> <span class="va">meses</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">resultado</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dfr</a></span><span class="op">(</span></span>
<span>  <span class="va">planilhas</span>, <span class="va">select</span>,</span>
<span>  <span class="va">Ano</span>, <span class="va">Mes</span>, <span class="va">IBGE1</span>, <span class="va">Municípios</span>, <span class="va">`Meio Ambiente`</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Para exportar o resultado:</span></span>
<span><span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html">write_csv2</a></span><span class="op">(</span></span>
<span>  <span class="va">resultado</span>, <span class="st">"tabela_para_SEMAD.csv"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p></p>
</div>
</div>
<div id="iterando-sobre-vários-inputs-simultaneamente" class="section level2" number="16.8">
<h2>
<span class="header-section-number">16.8</span> Iterando sobre vários <em>input</em>’s simultaneamente<a class="anchor" aria-label="anchor" href="#iterando-sobre-v%C3%A1rios-inputs-simultaneamente"><i class="fas fa-link"></i></a>
</h2>
<p>A medida em que você vai ganhando familiaridade com a família <code>map</code> de funções, você vai sentir a necessidade de expandir ainda mais as suas funcionalidades. Parte dessa expansão, reside em aplicar o <em>loop</em> implícito sobre um número maior de <em>input</em>’s. Por esse motivo, o pacote <code>purrr</code> também nos oferece as famílias <code>map2</code> e <code>pmap</code> de funções.</p>
<div id="utilizando-dois-inputs" class="section level3" number="16.8.1">
<h3>
<span class="header-section-number">16.8.1</span> Utilizando dois <em>input</em>’s<a class="anchor" aria-label="anchor" href="#utilizando-dois-inputs"><i class="fas fa-link"></i></a>
</h3>
<p>Como o próprio nome dá a entender, a única diferença entre as famílias <code>map</code> e <code>map2</code>, é que as funções <code>map2</code> recebem 2 objetos (<code>.x</code> e <code>.y</code>) diferentes de <em>input</em>. Ou seja, as funções <code>map2</code> buscam aplicar a função <code>.f</code> sobre cada elemento de <code>.x</code> e de <code>.y</code> de forma simultânea. Em mais detalhes, cada elemento de <code>.x</code> é repassado como primeiro argumento de <code>.f</code>, enquanto cada elemento de <code>.y</code> é posicionado no segundo argumento de <code>.f</code>.</p>
<p>Vale destacar que o <em>loop</em> (criado pela função <code>map2</code> em questão) é aplicado de forma paralela sobre os objetos <code>.x</code> e <code>.y</code>. Ou seja, na primeira iteração, serão utilizados os elementos <code>.x[[1]]</code> e <code>.y[[1]]</code>, na segunda iteração, os elementos <code>.x[[2]]</code> e <code>.y[[2]]</code>, e assim por diante. A figura 16.9 abaixo, apresenta tal <em>loop</em> de maneira gráfica:</p>
<p></p>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:unnamed-chunk-930"></span>
<img src="Figuras/map2_simple.png" alt="Representação da tarefa executada pela função \texttt{map\_dbl()}" width="80%"><p class="caption">
Figura 16.9: Representação da tarefa executada pela função
</p>
</div>
<p></p>
<p>Além disso, a família <code>map2</code> também tem um membro para cada estrutura de dado que você deseja retornar. Logo, a função <code><a href="https://purrr.tidyverse.org/reference/map2.html">map2()</a></code> retorna uma lista, <code><a href="https://purrr.tidyverse.org/reference/map2.html">map2_chr()</a></code>, um vetor do tipo <code>character</code>, <code><a href="https://purrr.tidyverse.org/reference/map2.html">map2_dfr()</a></code>, um <code>data.frame</code>, e assim por diante.</p>
<p>Como exemplo, suponha que você tivesse os dois vetores (<code>x</code> e <code>y</code>) abaixo. Agora, suponha também que você desejasse compilar os menores números possíveis entre esses dois vetores. Ou seja, você deseja encontrar o menor número entre cada elemento de <code>x</code> e <code>y</code>. Você poderia realizar esse trabalho, através das funções <code><a href="https://purrr.tidyverse.org/reference/map2.html">map2_int()</a></code> e <code><a href="https://rdrr.io/r/base/Extremes.html">min()</a></code>, como demonstrado abaixo:</p>
<p></p>
<div class="sourceCode" id="cb1750"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2L</span>, <span class="fl">6L</span>, <span class="fl">9L</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1L</span>, <span class="fl">7L</span>, <span class="fl">4L</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html">map2_int</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">min</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 1 6 4</code></pre>
<p></p>
<p>É importante frisar, que os objetos <code>.x</code> e <code>.y</code> precisam necessariamente ter o mesmo comprimento. Caso você não respeite essa regra, um erro será levantado pela função <code>map2</code> que você está utilizando.</p>
<p></p>
<div class="sourceCode" id="cb1752"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html">map2</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="va">sum</span><span class="op">)</span></span></code></pre></div>
<p></p>
<pre><code># Error: Mapped vectors must have consistent lengths:
# * `.x` has length 2
# * `.y` has length 3</code></pre>
</div>
<div id="utilizando-n-inputs" class="section level3" number="16.8.2">
<h3>
<span class="header-section-number">16.8.2</span> Utilizando <span class="math inline">\(n\)</span> <em>input</em>’s<a class="anchor" aria-label="anchor" href="#utilizando-n-inputs"><i class="fas fa-link"></i></a>
</h3>
<p>Se é possível utilizarmos 1 ou 2 <em>input</em>’s diferentes em uma função <code>map</code>, porque não permitirmos também um número arbitrário de <em>input</em>’s ? Esse é exatamente o objetivo que a família <code>pmap</code> de funções busca cumprir.</p>
<p>Assim como as demais famílias apresentadas até o momento, a família <code>pmap</code> também contém um membro para cada tipo de estrutura de dado que você deseja retornar. Sendo assim, <code><a href="https://purrr.tidyverse.org/reference/map2.html">pmap_int()</a></code> retorna um vetor do tipo <code>integer</code>, enquanto <code><a href="https://purrr.tidyverse.org/reference/map2.html">pmap()</a></code> retorna uma lista, e assim por diante.</p>
<p>Todavia, enquanto as funções <code>map</code> e <code>map2</code> podem receber um objeto qualquer em seus primeiros argumentos, uma função <code>pmap</code> recebe necessariamente uma lista (<code>.l</code>) em seu primeiro argumento. Essa lista deve conter todos os <em>input</em>’s sobre os quais você deseja aplicar o <em>loop</em>. Dito de outra forma, cada elemento dessa lista <code>.l</code> corresponde a um <em>input</em> diferente que será utilizado na função <code>.f</code>.</p>
<p>Isso significa que você deve armazenar todos os <em>input</em>’s (sobre os quais você deseja aplicar a função <code>.f</code>) dentro de uma lista, e, fornecer essa lista à função <code>pmap</code>. Apesar desse detalhe, uma função <code>pmap</code> aplica o <em>loop</em> de forma simultânea sobre todos os <em>input</em>’s (da mesma forma como ocorre com as funções <code>map</code> e <code>map2</code>).</p>
<p>Como resultado, se você fornece uma lista como <code>list(x, y, z)</code> à função <code>pmap</code>, na primeira iteração serão utilizados os elementos <code>x[[1]]</code>, <code>y[[1]]</code> e <code>z[[1]]</code>, já na segunda iteração, os elementos <code>x[[2]]</code>, <code>y[[2]]</code> e <code>z[[2]]</code>, e assim por diante. Esse processo está apresentado na figura 16.10 abaixo:</p>
<p></p>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:unnamed-chunk-933"></span>
<img src="Figuras/pmap_simple.png" alt="Representação da tarefa executada pela função \texttt{pmap\_dbl()}" width="100%"><p class="caption">
Figura 16.10: Representação da tarefa executada pela função
</p>
</div>
<p></p>
<p>Perceba também pela figura 16.10, que os elementos da lista <code>.l</code> são fornecidos como argumentos para a função <code>.f</code>, de acordo com a posição que eles ocupam na lista. Sendo assim, o primeiro elemento da lista <code>.l</code> é fornecido como primeiro argumento de <code>.f</code>, enquanto o segundo elemento, como segundo argumento de <code>.f</code>, e assim por diante.</p>
<p>A função <code>pmap</code> realiza essa correspondência por posição sempre que você não dá um nome específico para cada elemento da lista. Como exemplo, a função <code><a href="https://rdrr.io/r/stats/Normal.html">rnorm()</a></code> possui 3 argumentos (<code>n</code>, <code>mean</code> e <code>sd</code>). Caso eu nomeie os elementos da lista <code>.l</code> de acordo com esses 3 argumentos, eu posso reorganizar esses <em>input</em>’s dentro da lista <code>.l</code> da maneira que eu bem entender. Pois nesse caso, a função <code>pmap</code> em questão, vai conectar cada argumento da função aos nomes dos elementos da lista <code>.l</code>.</p>
<p>Como exemplo, repare abaixo, que o primeiro elemento da lista <code>args</code> foi corretamente associado ao argumento <code>mean</code>, mesmo que esse argumento não seja o primeiro argumento da função <code><a href="https://rdrr.io/r/stats/Normal.html">rnorm()</a></code>.</p>
<p></p>
<div class="sourceCode" id="cb1754"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">args</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>  mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">15</span>, <span class="fl">50</span>, <span class="fl">500</span><span class="op">)</span>, n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">5</span><span class="op">)</span>, sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html">pmap</a></span><span class="op">(</span><span class="va">args</span>, <span class="va">rnorm</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [[1]]
## [1] 14.37355 15.18364
## 
## [[2]]
## [1] 49.16437 51.59528 50.32951
## 
## [[3]]
## [1] 495.8977 502.4371 503.6916 502.8789 498.4731</code></pre>
<p></p>
<p>Pelo fato de um <code>data.frame</code> ser essencialmente, uma lista nomeada que contém elementos de mesmo comprimento, podemos armazenar tranquilamente os nossos <em>input</em>’s em um <code>data.frame</code>, e fornecê-lo à função <code>pmap</code>.</p>
<p></p>
<div class="sourceCode" id="cb1756"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">args</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>  mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">15</span>, <span class="fl">50</span>, <span class="fl">500</span><span class="op">)</span>, </span>
<span>  n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">5</span><span class="op">)</span>,</span>
<span>  sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html">pmap</a></span><span class="op">(</span><span class="va">args</span>, <span class="va">rnorm</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [[1]]
## [1] 14.37355 15.18364
## 
## [[2]]
## [1] 49.16437 51.59528 50.32951
## 
## [[3]]
## [1] 495.8977 502.4371 503.6916 502.8789 498.4731</code></pre>
<p></p>
<p>Um outro detalhe, é que assim como todas as funções <code>map</code> e <code>map2</code> que vimos até o momento, <code>pmap</code> também possui o argumento especial <code>...</code> para repassar argumentos específicos para a função <code>.f</code>. Logo, todo argumento que você fornecer após o (ou à direita do) argumento <code>.f</code>, são argumentos que serão sempre repassados à função <code>.f</code> em cada iteração do <em>loop</em>. No exemplo abaixo, estamos repassando os argumentos <code>na.rm = TRUE</code> e <code>names = TRUE</code> em todas as chamadas à função <code><a href="https://rdrr.io/r/stats/quantile.html">quantile()</a></code>.</p>
<p></p>
<div class="sourceCode" id="cb1758"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">args</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>  probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="fl">0.75</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">dists</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fl">2.5</span>, <span class="fl">8.1</span>, <span class="fl">3.9</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">42.2</span>, <span class="cn">NA</span>, <span class="fl">93.2</span>, <span class="fl">35.1</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.9</span>, <span class="fl">27.1</span>, <span class="fl">5.3</span>, <span class="cn">NA</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">args</span><span class="op">$</span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">dists</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html">pmap</a></span><span class="op">(</span><span class="va">args</span>, <span class="va">quantile</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span>, names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [[1]]
## 25% 
## 3.2 
## 
## [[2]]
##  50% 
## 42.2 
## 
## [[3]]
##  75% 
## 16.2</code></pre>
<p></p>
</div>
</div>
<div id="a-família-walk" class="section level2" number="16.9">
<h2>
<span class="header-section-number">16.9</span> A família <code>walk()</code><a class="anchor" aria-label="anchor" href="#a-fam%C3%ADlia-walk"><i class="fas fa-link"></i></a>
</h2>
<p>O pacote <code>purrr</code>, também nos oferece a família <code>walk</code> de funções, a qual é composta por apenas três membros: <code><a href="https://purrr.tidyverse.org/reference/map.html">walk()</a></code>, <code><a href="https://purrr.tidyverse.org/reference/map2.html">walk2()</a></code> e <code><a href="https://purrr.tidyverse.org/reference/map2.html">pwalk()</a></code>. Em resumo, as funções <code>walk</code> funcionam da mesma maneira que as funções <code>map</code>, contudo, elas não retornam, por padrão, algum resultado para o usuário.</p>
<p>Em mais detalhes, as funções <code>walk</code> constroem o <em>loop</em> implícito e aplicam a função <code>.f</code> sobre cada elemento dos objetos de <em>input</em>. Porém, essas funções não coletam os resultados gerados pela função <code>.f</code> a cada iteração, até porque, uma função <code>walk</code> tem como pressuposto, que a função <code>.f</code> não retorna nenhum resultado.</p>
<p>Por esse motivo, você geralmente utiliza a família <code>walk</code>, quando você deseja aplicar o mesmo <em>loop</em> implícito da família <code>map</code>, mas não está preocupado em coletar os resultados gerados. Ou ainda, quando a função <code>.f</code> que você deseja aplicar, não retorna um resultado por padrão, e sim, imprime alguma informação em seu console, ou altera objetos, configurações e <em>environments</em> presentes em sua sessão. No exemplo abaixo, estou aplicando a função <code><a href="https://rdrr.io/r/base/print.html">print()</a></code> sobre cada elemento de <code>l</code>.</p>
<p></p>
<div class="sourceCode" id="cb1760"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">l</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">walk</a></span><span class="op">(</span><span class="va">l</span>, <span class="va">print</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 1
## [1] 2
## [1] 3
## [1] 4</code></pre>
<p></p>
<p>Como você já deve ter inferido, a função <code><a href="https://purrr.tidyverse.org/reference/map.html">walk()</a></code> aceita um objeto (<code>.x</code>) de <em>input</em> e uma função <code>.f</code>, enquanto a função <code><a href="https://purrr.tidyverse.org/reference/map2.html">walk2()</a></code> aceita dois objetos (<code>.x</code> e <code>.y</code>) de <em>input</em> e uma função <code>.f</code>. Já a função <code><a href="https://purrr.tidyverse.org/reference/map2.html">pwalk()</a></code> aceita uma lista (<code>.l</code>) contendo <span class="math inline">\(n\)</span> objetos de <em>input</em>, além de uma função <code>.f</code>. Assim como as demais funções que vimos ao longo desse capítulo, essas três funções também possuem o argumento especial <code>...</code>, com o qual podemos repassar argumentos para a função <code>.f</code> em todas as chamadas executadas.</p>
</div>
<div id="agregando-resultados-com-reduce" class="section level2" number="16.10">
<h2>
<span class="header-section-number">16.10</span> Agregando resultados com <code>reduce()</code><a class="anchor" aria-label="anchor" href="#agregando-resultados-com-reduce"><i class="fas fa-link"></i></a>
</h2>
<p>Em algumas ocasiões, você tem uma lista complexa que você deseja reduzir para uma lista mais simples <span class="citation">(<a href="refer%C3%AAncias.html#ref-wickham2017" role="doc-biblioref">WICKHAM; GROLEMUND, 2017</a>)</span>. É em momentos como esse, que as funções <code><a href="https://rdrr.io/r/base/funprog.html">Reduce()</a></code> e <code><a href="https://purrr.tidyverse.org/reference/reduce.html">purrr::reduce()</a></code> se tornam extremamente úteis. Ambas as funções realizam exatamente o mesmo trabalho. A diferença entre elas, é que a função <code><a href="https://rdrr.io/r/base/funprog.html">Reduce()</a></code> pertence aos pacotes básicos do R, enquanto <code><a href="https://purrr.tidyverse.org/reference/reduce.html">reduce()</a></code> advém do pacote <code>purrr</code>.</p>
<p>Você possivelmente já conhece o termo <em>reduce</em>, especialmente se você já trabalhou com alguma outra linguagem de programação focada no paradigma FP. Mas esse termo também é muito associado ao modelo <em>MapReduce</em> que é comumente utilizado em ferramentas para processamento de <em>BigData</em>.</p>
<p>Em resumo, <code><a href="https://purrr.tidyverse.org/reference/reduce.html">reduce()</a></code> busca combinar todos os elementos de um objeto em um único valor. Ou seja, de certa forma, essa função <code><a href="https://purrr.tidyverse.org/reference/reduce.html">reduce()</a></code> calcula uma “agregação” dos elementos de um objeto. Esse processo combinatório de <code><a href="https://purrr.tidyverse.org/reference/reduce.html">reduce()</a></code> é uma operação bastante comum em diversos tipos de computação. Por isso, várias linguagens de programação oferecem uma função parecida com <code><a href="https://purrr.tidyverse.org/reference/reduce.html">reduce()</a></code>. Um exemplo é o método <code>functools.reduce()</code> da linguagem Python.</p>
<p>A forma como <code><a href="https://purrr.tidyverse.org/reference/reduce.html">reduce()</a></code> conduz essa combinação é na realidade, bastante simples. Considerando um objeto que possua 4 elementos como exemplo, <code><a href="https://purrr.tidyverse.org/reference/reduce.html">reduce()</a></code> vai primeiro, aplicar a função <code>.f</code> sobre os elementos 1 e 2, produzindo o resultado <code>r1</code>; em seguida, ela aplica novamente a função <code>.f</code> sobre o resultado anterior (<code>r1</code>) e o elemento 3, produzindo assim, o resultado <code>r2</code>; em seguida, ela aplica a função <code>.f</code> sobre o resultado anterior (<code>r2</code>), e o elemento 4, produzindo assim, o resultado final <code>r3</code>, que contém dentro de si, um resumo de todos os 4 elementos do objeto. Descrevendo de outra forma, o resultado de uma expressão como <code>reduce(1:4, f)</code> seria <code>f(f(f(1, 2), 3), 4)</code>. Tal processo de combinação está apresentado de maneira gráfica na figura 16.11 abaixo:</p>
<p></p>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:unnamed-chunk-938"></span>
<img src="Figuras/reduce.png" alt="Representação da combinação executada por `reduce()`" width="90%"><p class="caption">
Figura 16.11: Representação da combinação executada por <code><a href="https://purrr.tidyverse.org/reference/reduce.html">reduce()</a></code>
</p>
</div>
<p></p>
<p>Um dos exemplos mais clássicos de uso da função <code><a href="https://purrr.tidyverse.org/reference/reduce.html">reduce()</a></code> ao longo de várias linguagens de programação, seria o cálculo de uma soma vetorizada. Ou seja, através da função <code><a href="https://purrr.tidyverse.org/reference/reduce.html">reduce()</a></code> conseguimos reproduzir a mesma funcionalidade da função <code><a href="https://rdrr.io/r/base/sum.html">sum()</a></code>. No exemplo abaixo, a função <code><a href="https://purrr.tidyverse.org/reference/reduce.html">reduce()</a></code> está calculando o valor da expressão <code>(((1+2)+3)+4)+5</code>, que é basicamente o mesmo cálculo de <code>sum(1:5)</code>.</p>
<p></p>
<div class="sourceCode" id="cb1762"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://purrr.tidyverse.org/reference/reduce.html">reduce</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="va">`+`</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 15</code></pre>
<div class="sourceCode" id="cb1764"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## O mesmo cálculo:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 15</code></pre>
<p></p>
<p>Com esse exemplo em mente, podemos expandi-lo com facilidade para as demais operações aritméticas, como multiplicação, potência e divisão:</p>
<p></p>
<div class="sourceCode" id="cb1766"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Multiplicação:</span></span>
<span><span class="fu"><a href="https://purrr.tidyverse.org/reference/reduce.html">reduce</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="va">`*`</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 120</code></pre>
<div class="sourceCode" id="cb1768"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Divisão:</span></span>
<span><span class="fu"><a href="https://purrr.tidyverse.org/reference/reduce.html">reduce</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="va">`/`</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 0.008333333</code></pre>
<div class="sourceCode" id="cb1770"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Potência:</span></span>
<span><span class="fu"><a href="https://purrr.tidyverse.org/reference/reduce.html">reduce</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="va">`^`</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 1</code></pre>
<p></p>
<p>Um outro exemplo em que <code><a href="https://purrr.tidyverse.org/reference/reduce.html">reduce()</a></code> se torna extremamente útil, seria quando desejamos unir vários <code>data.frame</code>’s através de <em>join</em>’s (os quais apresentamos no capítulo 6). Fica meio chato, escrevermos vários <em>join</em>’s separados para unirmos todas essas tabelas, e a função <code><a href="https://purrr.tidyverse.org/reference/reduce.html">reduce()</a></code> oferece uma maneira elegante e eficiente de resumirmos essa operação.</p>
<p></p>
<div class="sourceCode" id="cb1772"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dias</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>  dia <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.Date.html">seq.Date</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2021-12-01"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2021-12-10"</span><span class="op">)</span>, by <span class="op">=</span> <span class="st">"1 day"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">savassi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>  dia <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2021-12-01"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2021-12-03"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2021-12-05"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  vendas_savassi <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1200</span>, <span class="fl">4500</span>, <span class="fl">3400</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">centro</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>  dia <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2021-12-02"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2021-12-03"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2021-12-04"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2021-12-05"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2021-12-07"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2021-12-10"</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  vendas_centro <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2400</span>, <span class="fl">3600</span>, <span class="fl">3100</span>, <span class="fl">1400</span>, <span class="fl">1500</span>, <span class="fl">2700</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">barreiro</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>  dia <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2021-12-07"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2021-12-08"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2021-12-09"</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  vendas_barreiro <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5400</span>, <span class="fl">4500</span>, <span class="fl">8700</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Unindo todas essas tabelas através de um FULL JOIN:</span></span>
<span><span class="fu"><a href="https://purrr.tidyverse.org/reference/reduce.html">reduce</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">dias</span>, <span class="va">savassi</span>, <span class="va">centro</span>, <span class="va">barreiro</span><span class="op">)</span>, <span class="va">full_join</span>, by <span class="op">=</span> <span class="st">"dia"</span><span class="op">)</span></span></code></pre></div>
<pre><code>##           dia vendas_savassi vendas_centro vendas_barreiro
## 1  2021-12-01           1200            NA              NA
## 2  2021-12-02             NA          2400              NA
## 3  2021-12-03           4500          3600              NA
## 4  2021-12-04             NA          3100              NA
## 5  2021-12-05           3400          1400              NA
## 6  2021-12-06             NA            NA              NA
## 7  2021-12-07             NA          1500            5400
## 8  2021-12-08             NA            NA            4500
## 9  2021-12-09             NA            NA            8700
## 10 2021-12-10             NA          2700              NA</code></pre>
<p></p>
<p>Apesar da praticidade de <code><a href="https://purrr.tidyverse.org/reference/reduce.html">reduce()</a></code>, é importante que você conheça muito bem a operação que você está aplicando sobre os elementos. Pois a depender da forma como essa operação é realizada, a direção do processo combinatório realizado por <code><a href="https://purrr.tidyverse.org/reference/reduce.html">reduce()</a></code> pode te levar a diferentes resultados.</p>
<p>Como um primeiro exemplo, quando aplicamos o operador de potenciação (<code>^</code>) sobre o vetor <code>1:4</code>, o resultado gerado por <code><a href="https://purrr.tidyverse.org/reference/reduce.html">reduce()</a></code> é de 1. Pois a função calculou o valor da expressão <code>(((1^2)^3)^4)</code>. Ou seja, estamos elevando repetidamente 1 a um determinado número, e 1 elevado a qualquer coisa é sempre igual a 1.</p>
<p></p>
<div class="sourceCode" id="cb1774"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://purrr.tidyverse.org/reference/reduce.html">reduce</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, <span class="va">`^`</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 1</code></pre>
<p></p>
<p>Se invertermos a ordem da combinação (através do argumento <code>.dir</code>), o mesmo resultado é retornado. Pois dessa forma, <code><a href="https://purrr.tidyverse.org/reference/reduce.html">reduce()</a></code> está calculando o valor da expressão <code>(1^(2^(3^4)))</code>. Ou seja, no fim das contas, ainda estamos elevando 1 a um número gigantesco.</p>
<p></p>
<div class="sourceCode" id="cb1776"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://purrr.tidyverse.org/reference/reduce.html">reduce</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, <span class="va">`^`</span>, .dir <span class="op">=</span> <span class="st">"backward"</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 1</code></pre>
<p>
Entretanto, não se engane por esse caso especial, ou por essa exceção à regra. Pois o resultado da operação de potenciação depende sim da ordem em que os elementos são combinados. Podemos enxergar isso, ao retirarmos o número 1 dessa expressão. Portanto, as expressões <code>((2^3)^4)</code> e <code>(2^(3^4))</code>, calculadas abaixo por <code><a href="https://purrr.tidyverse.org/reference/reduce.html">reduce()</a></code>, geram resultados diferentes, pois elas resultam em <span class="math inline">\(8^4\)</span> e <span class="math inline">\(2^{81}\)</span> (respectivamente).</p>
<p></p>
<div class="sourceCode" id="cb1778"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://purrr.tidyverse.org/reference/reduce.html">reduce</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">4</span>, <span class="va">`^`</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 4096</code></pre>
<div class="sourceCode" id="cb1780"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://purrr.tidyverse.org/reference/reduce.html">reduce</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">4</span>, <span class="va">`^`</span>, .dir <span class="op">=</span> <span class="st">"backward"</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 2.417852e+24</code></pre>
<p></p>
<p>Como um segundo exemplo, perceba que a estrutura das listas <code>a</code> e <code>b</code> abaixo são diferentes, mesmo que ambas tenham sido construídas com base no mesmo objeto (<code>1:4</code>) e função (<code>list</code>).</p>
<p></p>
<div class="sourceCode" id="cb1782"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/reduce.html">reduce</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, <span class="va">list</span><span class="op">)</span></span>
<span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/reduce.html">reduce</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, <span class="va">list</span>, .dir <span class="op">=</span> <span class="st">"backward"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">a</span><span class="op">)</span></span></code></pre></div>
<pre><code>## List of 2
##  $ :List of 2
##   ..$ :List of 2
##   .. ..$ : int 1
##   .. ..$ : int 2
##   ..$ : int 3
##  $ : int 4</code></pre>
<div class="sourceCode" id="cb1784"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">b</span><span class="op">)</span></span></code></pre></div>
<pre><code>## List of 2
##  $ : int 1
##  $ :List of 2
##   ..$ : int 2
##   ..$ :List of 2
##   .. ..$ : int 3
##   .. ..$ : int 4</code></pre>
<p></p>
<p>Sendo assim, a depender da função que você está aplicando através de <code><a href="https://purrr.tidyverse.org/reference/reduce.html">reduce()</a></code>, você terá que inverter a ordem da combinação através do argumento <code>.dir</code>, para chegar ao resultado que você deseja.</p>
</div>
<div id="acumulando-resultados-com-accumulate" class="section level2" number="16.11">
<h2>
<span class="header-section-number">16.11</span> Acumulando resultados com <code>accumulate()</code><a class="anchor" aria-label="anchor" href="#acumulando-resultados-com-accumulate"><i class="fas fa-link"></i></a>
</h2>
<p>Se podemos combinar os diversos resultados gerados para produzir um único valor, também podemos “acumular” esses resultados, através da função <code><a href="https://purrr.tidyverse.org/reference/accumulate.html">accumulate()</a></code>. Esse processo é um pouco diferente, pois, ao invés de produzir um único valor, ele acaba produzindo um novo objeto de mesmo comprimento que o objeto de <em>input</em>. Contudo, esse processo ainda herda parte da metodologia combinatória empregada por <code><a href="https://purrr.tidyverse.org/reference/reduce.html">reduce()</a></code>.</p>
<p>Como exemplo, quando utilizamos <code><a href="https://purrr.tidyverse.org/reference/accumulate.html">accumulate()</a></code> para aplicar o operador de soma (<code>+</code>) sobre o vetor <code>1:4</code>, o resultado é a soma acumulada do vetor. Ou seja, a expressão abaixo é equivalente à expressão <code>cumsum(1:4)</code>.</p>
<p></p>
<div class="sourceCode" id="cb1786"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://purrr.tidyverse.org/reference/accumulate.html">accumulate</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, <span class="va">`+`</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1]  1  3  6 10</code></pre>
<p></p>
<p>Com esse exemplo, podemos entender um pouco melhor o que <code><a href="https://purrr.tidyverse.org/reference/accumulate.html">accumulate()</a></code> faz. Em resumo, <code><a href="https://purrr.tidyverse.org/reference/accumulate.html">accumulate()</a></code> aplica o mesmo processo combinatório de <code><a href="https://purrr.tidyverse.org/reference/reduce.html">reduce()</a></code>, porém, ele armazena cada resultado gerado ao longo do processo. A figura 16.12 abaixo, traz uma representação do processo executado por <code><a href="https://purrr.tidyverse.org/reference/accumulate.html">accumulate()</a></code>.</p>
<p>Perceba nessa figura, que para retornar um novo objeto de mesmo comprimento que o objeto de <em>input</em>, <code><a href="https://purrr.tidyverse.org/reference/accumulate.html">accumulate()</a></code> precisa gerar um resultado para cada elemento deste objeto. Devido a essa regra, na primeira iteração, <code><a href="https://purrr.tidyverse.org/reference/accumulate.html">accumulate()</a></code> precisa aplicar a função <code>.f</code> somente sobre o primeiro elemento do objeto de <em>input</em>, para nas próximas iterações, aplicar a função <code>.f</code> em pares.</p>
<p></p>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:unnamed-chunk-947"></span>
<img src="Figuras/accumulate.png" alt="Representação da tarefa executada por `accumulate()`" width="100%"><p class="caption">
Figura 16.12: Representação da tarefa executada por <code><a href="https://purrr.tidyverse.org/reference/accumulate.html">accumulate()</a></code>
</p>
</div>
<p></p>
<p>Caso <code><a href="https://purrr.tidyverse.org/reference/accumulate.html">accumulate()</a></code> não fizesse esse passo na primeira iteração, a função nos retornaria um novo objeto de <span class="math inline">\(n-1\)</span> elementos, para um objeto de <em>input</em> de <span class="math inline">\(n\)</span> elementos. O que desrespeitaria a regra de mesmo comprimento entre o <em>input</em> e <em>output</em> da função.</p>
<p>Descrevendo ainda de uma outra forma, a expressão <code>accumulate(1:4, f)</code> resulta em um vetor de 4 elementos, onde o primeiro elemento contém o resultado de <code>f(1)</code>; o segundo elemento, de <code>f(f(1),2)</code>; o terceiro elemento, de <code>f(f(f(1),2),3)</code>; e o quarto elemento, de <code>f(f(f(f(1),2),3),4)</code>.</p>
<p>Assim como ocorre em <code><a href="https://purrr.tidyverse.org/reference/reduce.html">reduce()</a></code>, <code><a href="https://purrr.tidyverse.org/reference/accumulate.html">accumulate()</a></code> também possui um argumento <code>.dir</code> que define a direção do processo combinatório. Ao invertermos a ordem desse processo, os 4 elementos do vetor resultante da expressão <code>accumulate(1:4, f)</code> conteriam os resultados das expressões <code>f(f(f(f(4),3),2),1)</code>, <code>f(f(f(4),3),2)</code>, <code>f(f(4),3)</code> e <code>f(4)</code>, respectivamente.</p>
<p></p>
<div class="sourceCode" id="cb1788"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://purrr.tidyverse.org/reference/accumulate.html">accumulate</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, <span class="va">`+`</span>, .dir <span class="op">=</span> <span class="st">"backward"</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 10  9  7  4</code></pre>
<p></p>
</div>
<div id="exercícios-12" class="section level2 unnumbered">
<h2>Exercícios<a class="anchor" aria-label="anchor" href="#exerc%C3%ADcios-12"><i class="fas fa-link"></i></a>
</h2>
<p><strong>Questão 16.1.</strong> Os itens dessa questão foram inspirados em um exercício da obra de . Considerando a tabela <code>diamonds</code> do pacote <code>ggplot2</code> (lembre-se que você pode acessar essa tabela através do comando <code><a href="https://ggplot2.tidyverse.org/reference/diamonds.html">ggplot2::diamonds</a></code>), utilize as funções da família <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> para calcular:</p>
<p>16.1.A) A média de todas as colunas numéricas.</p>
<p>16.1.B) O número de valores distintos em todas as colunas não numéricas.</p>
<p><strong>Questão 16.2.</strong> Os itens dessa questão foram retirados de um exercício da obra de .</p>
<p>16.2.A) Tente explicar com suas palavras, o que exatamente o comando abaixo está fazendo. Porque cada elemento da lista resultante contém cada vez mais elementos?</p>
<p></p>
<div class="sourceCode" id="cb1790"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="va">rnorm</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [[1]]
## [1] 1.511781
## 
## [[2]]
## [1]  0.3898432 -0.6212406
## 
## [[3]]
## [1] -2.21469989  1.12493092 -0.04493361
## 
## [[4]]
## [1] -0.01619026  0.94383621  0.82122120  0.59390132
## 
## [[5]]
## [1]  0.91897737  0.78213630  0.07456498 -1.98935170  0.61982575</code></pre>
<p></p>
<p>16.2.B) Considerando o comando abaixo, o que exatamente ele está fazendo de diferente do comando mostrado no item anterior? Porque o resultado é diferente?</p>
<p></p>
<div class="sourceCode" id="cb1792"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="va">rnorm</span>, n <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [[1]]
## [1]  0.9438713  0.8442045 -0.4707524  0.5218499  1.4179416
## 
## [[2]]
## [1] 3.3586796 1.8972123 2.3876716 1.9461950 0.6229404
## 
## [[3]]
## [1] 2.585005 2.605710 2.940687 4.100025 3.763176
## 
## [[4]]
## [1] 3.835476 3.746638 4.696963 4.556663 3.311244
## 
## [[5]]
## [1] 4.292505 5.364582 5.768533 4.887654 5.881108</code></pre>
<p></p>
<p><strong>Questão 16.3.</strong> Em cada item abaixo, você deve utilizar uma das funções <code>map</code> para aplicar um teste lógico sobre os elementos de uma lista e, filtrar os elementos dessa lista de acordo com os resultados desse teste lógico.</p>
<p>16.3.A) Considerando a lista <code>l</code> abaixo, utilize uma das funções <code>map</code> para descobrir que elementos de <code>l</code> possuem comprimento maior que 3.</p>
<p></p>
<div class="sourceCode" id="cb1794"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">l</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">5</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">6</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">9</span>, <span class="fl">8</span>, <span class="fl">9</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">7</span>, <span class="fl">4</span>, <span class="fl">4</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p></p>
<p>16.3.B) Elimine todos os elementos da lista <code>l</code> abaixo, que possuem pelo menos um valor <code>NA</code>.</p>
<p></p>
<div class="sourceCode" id="cb1795"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">l</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">6</span>, <span class="fl">7</span>, <span class="cn">NA</span>, <span class="fl">9</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="cn">NA</span>, <span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">4</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">3</span>, <span class="fl">1</span>, <span class="fl">8</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">6</span>, <span class="fl">6</span>, <span class="fl">6</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p></p>

</div>
</div>

  <div class="chapter-nav">
<div class="prev"><a href="loops.html"><span class="header-section-number">15</span> Loops</a></div>
<div class="next"><a href="debugging---resolvendo-bugs-em-suas-fun%C3%A7%C3%B5es.html"><span class="header-section-number">17</span> Debugging - Resolvendo bugs em suas funções</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#functional-programming-com-purrr"><span class="header-section-number">16</span> Functional programming com purrr</a></li>
<li><a class="nav-link" href="#introdu%C3%A7%C3%A3o-2"><span class="header-section-number">16.1</span> Introdução</a></li>
<li>
<a class="nav-link" href="#loops-impl%C3%ADcitos-com-a-fam%C3%ADlia-map"><span class="header-section-number">16.2</span> Loops implícitos com a família map</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#a-fam%C3%ADlia-de-fun%C3%A7%C3%B5es-map"><span class="header-section-number">16.2.1</span> A família de funções map()</a></li>
<li><a class="nav-link" href="#no-fundo-estamos-utilizando-um-for-loop"><span class="header-section-number">16.2.2</span> No fundo, estamos utilizando um for loop</a></li>
<li><a class="nav-link" href="#se-n%C3%A3o-existe-uma-solu%C3%A7%C3%A3o-pronta-no-r-crie-a-sua-pr%C3%B3pria"><span class="header-section-number">16.2.3</span> Se não existe uma solução pronta no R, crie a sua própria</a></li>
<li><a class="nav-link" href="#alguns-atalhos-%C3%BAteis-das-fun%C3%A7%C3%B5es-map"><span class="header-section-number">16.2.4</span> Alguns atalhos úteis das funções map</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#um-estudo-de-caso-aplicando-um-modelo-econom%C3%A9trico-sobre-diferentes-pa%C3%ADses"><span class="header-section-number">16.3</span> Um estudo de caso: aplicando um modelo econométrico sobre diferentes países</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#a-fun%C3%A7%C3%A3o-que-calcula-o-modelo-econom%C3%A9trico"><span class="header-section-number">16.3.1</span> A função que calcula o modelo econométrico</a></li>
<li><a class="nav-link" href="#criando-uma-lista-de-data.frames"><span class="header-section-number">16.3.2</span> Criando uma lista de data.frame’s</a></li>
<li><a class="nav-link" href="#com-a-fun%C3%A7%C3%A3o-split"><span class="header-section-number">16.3.3</span> Com a função split()</a></li>
<li><a class="nav-link" href="#com-a-fun%C3%A7%C3%A3o-nest"><span class="header-section-number">16.3.4</span> Com a função nest()</a></li>
</ul>
</li>
<li><a class="nav-link" href="#comparando-a-fam%C3%ADlia-map-%C3%A0-fam%C3%ADlia-apply"><span class="header-section-number">16.4</span> Comparando a família map à família apply</a></li>
<li><a class="nav-link" href="#identificando-erros-nas-fun%C3%A7%C3%B5es-map"><span class="header-section-number">16.5</span> Identificando erros nas funções map</a></li>
<li><a class="nav-link" href="#compreendendo-as-fun%C3%A7%C3%B5es-map_dfr-e-map_dfc"><span class="header-section-number">16.6</span> Compreendendo as funções map_dfr() e map_dfc()</a></li>
<li>
<a class="nav-link" href="#sec:demanda_dist_ICMS"><span class="header-section-number">16.7</span> Um estudo de caso: uma demanda real sobre a distribuição de ICMS</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#a-demanda-em-si"><span class="header-section-number">16.7.1</span> A demanda em si</a></li>
<li><a class="nav-link" href="#planejando-os-passos"><span class="header-section-number">16.7.2</span> Planejando os passos</a></li>
<li><a class="nav-link" href="#importando-as-planilhas"><span class="header-section-number">16.7.3</span> Importando as planilhas</a></li>
<li><a class="nav-link" href="#conferindo-a-estrutura-dos-arquivos"><span class="header-section-number">16.7.4</span> Conferindo a estrutura dos arquivos</a></li>
<li><a class="nav-link" href="#adicionando-colunas-de-refer%C3%AAncia"><span class="header-section-number">16.7.5</span> Adicionando colunas de referência</a></li>
<li><a class="nav-link" href="#selecionando-apenas-as-colunas-relevantes"><span class="header-section-number">16.7.6</span> Selecionando apenas as colunas relevantes</a></li>
<li><a class="nav-link" href="#unindo-as-12-planilhas-em-uma-s%C3%B3"><span class="header-section-number">16.7.7</span> Unindo as 12 planilhas em uma só</a></li>
<li><a class="nav-link" href="#conclus%C3%A3o"><span class="header-section-number">16.7.8</span> Conclusão</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#iterando-sobre-v%C3%A1rios-inputs-simultaneamente"><span class="header-section-number">16.8</span> Iterando sobre vários input’s simultaneamente</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#utilizando-dois-inputs"><span class="header-section-number">16.8.1</span> Utilizando dois input’s</a></li>
<li><a class="nav-link" href="#utilizando-n-inputs"><span class="header-section-number">16.8.2</span> Utilizando \(n\) input’s</a></li>
</ul>
</li>
<li><a class="nav-link" href="#a-fam%C3%ADlia-walk"><span class="header-section-number">16.9</span> A família walk()</a></li>
<li><a class="nav-link" href="#agregando-resultados-com-reduce"><span class="header-section-number">16.10</span> Agregando resultados com reduce()</a></li>
<li><a class="nav-link" href="#acumulando-resultados-com-accumulate"><span class="header-section-number">16.11</span> Acumulando resultados com accumulate()</a></li>
<li><a class="nav-link" href="#exerc%C3%ADcios-12">Exercícios</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/pedropark99/Introducao_R//blob/main/18-purrr.Rmd">View source <i class="fas fa-book-open"></i></a></li>
          <li><a id="book-edit" href="https://github.com/pedropark99/Introducao_R//edit/main/18-purrr.Rmd">Edit this page <i class="fas fa-book-open"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Introdução à Linguagem R: seus fundamentos e sua prática</strong>" was written by Pedro Faria. It was last built on 2022-11-30.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
